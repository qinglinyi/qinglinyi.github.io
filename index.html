<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge" >
  <title>青林亦</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="知其然知其所以然">
<meta property="og:type" content="website">
<meta property="og:title" content="青林亦">
<meta property="og:url" content="http://www.qinglinyi.com/index.html">
<meta property="og:site_name" content="青林亦">
<meta property="og:description" content="知其然知其所以然">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="青林亦">
<meta name="twitter:description" content="知其然知其所以然">
  
    <link rel="alternative" href="/atom.xml" title="青林亦" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" href="/css/style.css">
</head>

<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img lazy-src="/images/header.jpg" class="js-avatar">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">青林亦</a></h1>
		</hgroup>

		
		<p class="header-subtitle">知其然知其所以然</p>
		

		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						
						<div class="icon-wrap icon-me hide" data-idx="3">
							<div class="user"></div>
							<div class="shoulder"></div>
						</div>
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>菜单</li>
						<li>标签</li>
						
						
						<li>关于我</li>
						
					</ul>
				</div>
			</div>
		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">主页</a></li>
				        
							<li><a href="/archives">所有文章</a></li>
				        
							<li><a href="/tags/hexo">Hexo</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
								<a class="github" target="_blank" href="https://github.com/qinglinyi" title="github">github</a>
					        
								<a class="weibo" target="_blank" href="#" title="weibo">weibo</a>
					        
								<a class="rss" target="_blank" href="/atom.xml" title="rss">rss</a>
					        
						</div>
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/Android/" style="font-size: 20px;">Android</a> <a href="/tags/Broadcast/" style="font-size: 10px;">Broadcast</a> <a href="/tags/Fragment/" style="font-size: 10px;">Fragment</a> <a href="/tags/Github/" style="font-size: 10px;">Github</a> <a href="/tags/Handler/" style="font-size: 10px;">Handler</a> <a href="/tags/Hexo/" style="font-size: 10px;">Hexo</a> <a href="/tags/Java/" style="font-size: 15px;">Java</a> <a href="/tags/Java基础/" style="font-size: 12.5px;">Java基础</a> <a href="/tags/Log/" style="font-size: 10px;">Log</a> <a href="/tags/Mac/" style="font-size: 10px;">Mac</a> <a href="/tags/Retrofit/" style="font-size: 10px;">Retrofit</a> <a href="/tags/Retrofit2/" style="font-size: 10px;">Retrofit2</a> <a href="/tags/Service/" style="font-size: 10px;">Service</a> <a href="/tags/String/" style="font-size: 10px;">String</a> <a href="/tags/property-animation/" style="font-size: 17.5px;">property animation</a> <a href="/tags/反射/" style="font-size: 10px;">反射</a> <a href="/tags/多线程/" style="font-size: 12.5px;">多线程</a> <a href="/tags/属性动画/" style="font-size: 17.5px;">属性动画</a> <a href="/tags/并发/" style="font-size: 12.5px;">并发</a> <a href="/tags/源码解析/" style="font-size: 10px;">源码解析</a> <a href="/tags/笔记/" style="font-size: 10px;">笔记</a> <a href="/tags/记录/" style="font-size: 10px;">记录</a> <a href="/tags/进程/" style="font-size: 10px;">进程</a>
					</div>
				</section>
				
				
				

				
				
				<section class="switch-part switch-part3">
				
					<div id="js-aboutme">Android coder</div>
				</section>
				
			</div>
		</div>
	</header>				
</div>

    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide">青林亦</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
			
				<img lazy-src="/images/header.jpg" class="js-avatar">
			
			</div>
			<hgroup>
			  <h1 class="header-author">青林亦</h1>
			</hgroup>
			
			<p class="header-subtitle">知其然知其所以然</p>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/archives">所有文章</a></li>
		        
					<li><a href="/tags/hexo">Hexo</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://github.com/qinglinyi" title="github">github</a>
			        
						<a class="weibo" target="_blank" href="#" title="weibo">weibo</a>
			        
						<a class="rss" target="_blank" href="/atom.xml" title="rss">rss</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>

      <div class="body-wrap">
  
    <article id="post-ios_jinli_licenses" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/posts/ios_jinli_licenses/" class="article-date">
  	<time datetime="2018-11-23T08:03:53.000Z" itemprop="datePublished">2018-11-23</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/posts/ios_jinli_licenses/">iOS隐私政策(中文)</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>本应用尊重并保护所有使用服务用户的个人隐私权。为了给您提供更准确、更有个性化的服务，本应用会按照本隐私权政策的规定使用和披露您的个人信息。但本应用将以高度的勤勉、审慎义务对待这些信息。除本隐私权政策另有规定外，在未征得您事先许可的情况下，本应用不会将这些信息对外披露或向第三方提供。本应用会不时更新本隐私权政策。 您在同意本应用服务使用协议之时，即视为您已经同意本隐私权政策全部内容。本隐私权政策属于本应用服务使用协议不可分割的一部分。</p>
<p>1.适用范围 </p>
<p>(a) 在您注册本应用帐号时，您根据本应用要求提供的个人注册信息；</p>
<p>(b) 在您使用本应用网络服务，或访问本应用平台网页时，本应用自动接收并记录的您的浏览器和计算机上的信息，包括但不限于您的IP地址、浏览器的类型、使用的语言、访问日期和时间、软硬件特征信息及您需求的网页记录等数据；</p>
<p>(c) 本应用通过合法途径从商业伙伴处取得的用户个人数据。</p>
<p>您了解并同意，以下信息不适用本隐私权政策：</p>
<p>(a) 您在使用本应用平台提供的搜索服务时输入的关键字信息；</p>
<p>(b) 本应用收集到的您在本应用发布的有关信息数据，包括但不限于参与活动、成交信息及评价详情；</p>
<p>(c) 违反法律规定或违反本应用规则行为及本应用已对您采取的措施。</p>
<p>2.信息使用</p>
<p>(a)本应用不会向任何无关第三方提供、出售、出租、分享或交易您的个人信息，除非事先得到您的许可，或该第三方和本应用（含本应用关联公司）单独或共同为您提供服务，且在该服务结束后，其将被禁止访问包括其以前能够访问的所有这些资料。</p>
<p>(b) 本应用亦不允许任何第三方以任何手段收集、编辑、出售或者无偿传播您的个人信息。任何本应用平台用户如从事上述活动，一经发现，本应用有权立即终止与该用户的服务协议。</p>
<p>(c) 为服务用户的目的，本应用可能通过使用您的个人信息，向您提供您感兴趣的信息，包括但不限于向您发出产品和服务信息，或者与本应用合作伙伴共享信息以便他们向您发送有关其产品和服务的信息（后者需要您的事先同意）。</p>
<p>3.信息披露</p>
<p>在如下情况下，本应用将依据您的个人意愿或法律的规定全部或部分的披露您的个人信息：</p>
<p>(a) 经您事先同意，向第三方披露；</p>
<p>(b)为提供您所要求的产品和服务，而必须和第三方分享您的个人信息；</p>
<p>(c) 根据法律的有关规定，或者行政或司法机构的要求，向第三方或者行政、司法机构披露；</p>
<p>(d) 如您出现违反中国有关法律、法规或者本应用服务协议或相关规则的情况，需要向第三方披露；</p>
<p>(e) 如您是适格的知识产权投诉人并已提起投诉，应被投诉人要求，向被投诉人披露，以便双方处理可能的权利纠纷；</p>
<p>(f) 在本应用平台上创建的某一交易中，如交易任何一方履行或部分履行了交易义务并提出信息披露请求的，本应用有权决定向该用户提供其交易对方的联络方式等必要信息，以促成交易的完成或纠纷的解决。</p>
<p>(g) 其它本应用根据法律、法规或者网站政策认为合适的披露。</p>
<p>4.信息存储和交换</p>
<p>本应用收集的有关您的信息和资料将保存在本应用及（或）其关联公司的服务器上，这些信息和资料可能传送至您所在国家、地区或本应用收集信息和资料所在地的境外并在境外被访问、存储和展示。</p>
<p>5.Cookie的使用</p>
<p>(a) 在您未拒绝接受cookies的情况下，本应用会在您的计算机上设定或取用cookies ，以便您能登录或使用依赖于cookies的本应用平台服务或功能。本应用使用cookies可为您提供更加周到的个性化服务，包括推广服务。</p>
<p>(b) 您有权选择接受或拒绝接受cookies。您可以通过修改浏览器设置的方式拒绝接受cookies。但如果您选择拒绝接受cookies，则您可能无法登录或使用依赖于cookies的本应用网络服务或功能。</p>
<p>(c) 通过本应用所设cookies所取得的有关信息，将适用本政策。</p>
<p>6.信息安全</p>
<p>(a) 本应用帐号均有安全保护功能，请妥善保管您的用户名及密码信息。本应用将通过对用户密码进行加密等安全措施确保您的信息不丢失，不被滥用和变造。尽管有前述安全措施，但同时也请您注意在信息网络上不存在“完善的安全措施”。</p>
<p>(b) 在使用本应用网络服务进行网上交易时，您不可避免的要向交易对方或潜在的交易对</p>
<p>7.本隐私政策的更改</p>
<p>(a)如果决定更改隐私政策，我们会在本政策中、本公司网站中以及我们认为适当的位置发布这些更改，以便您了解我们如何收集、使用您的个人信息，哪些人可以访问这些信息，以及在什么情况下我们会透露这些信息。</p>
<p>(b)本公司保留随时修改本政策的权利，因此请经常查看。如对本政策作出重大更改，本公司会通过网站通知的形式告知。</p>
<p>方披露自己的个人信息，如联络方式或者邮政地址。请您妥善保护自己的个人信息，仅在必要的情形下向他人提供。如您发现自己的个人信息泄密，尤其是本应用用户名及密码发生泄露，请您立即联络本应用客服，以便本应用采取相应措施。</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>











  
    <article id="post-ANR" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/posts/ANR/" class="article-date">
  	<time datetime="2018-08-05T10:53:56.000Z" itemprop="datePublished">2018-08-05</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/posts/ANR/">ANR</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="ANR"><a href="#ANR" class="headerlink" title="ANR"></a>ANR</h2><p><img src="/images/android/ANR.png" width="702" height="415" alt="ANR"></p>
<h3 id="What"><a href="#What" class="headerlink" title="What"></a>What</h3><p>Application Not Responding即应用无响应</p>
<h3 id="Why"><a href="#Why" class="headerlink" title="Why"></a>Why</h3><p>UI线程响应超时才会导致ANR，一般有两个原因：</p>
<ol>
<li>当前事件有没机会得到处理，被堵塞</li>
<li>当前事件正在处理，但是耗时太长还没有完成</li>
</ol>
<p>根据组件有可以分为：</p>
<ol>
<li>View的按键或者触摸事件5s内无法响应</li>
<li>BroadcastReceiver在onReceive中10s没有完成处理</li>
<li>Service的各个生命周期在20s内没有完成处理</li>
</ol>
<h3 id="How"><a href="#How" class="headerlink" title="How"></a>How</h3><p>根据原因，避免在主线程做耗时操作</p>
<h3 id="定位分析"><a href="#定位分析" class="headerlink" title="定位分析"></a>定位分析</h3><p>分析 data/anr/traces.txt</p>
<h3 id="避免检测"><a href="#避免检测" class="headerlink" title="避免检测"></a>避免检测</h3><ol>
<li>StrictMode-严格模式：有线程策略</li>
<li>BlockCanary</li>
</ol>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/">Android</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/Android/">Android</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>











  
    <article id="post-Android_Process" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/posts/Android_Process/" class="article-date">
  	<time datetime="2018-08-05T09:53:56.000Z" itemprop="datePublished">2018-08-05</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/posts/Android_Process/">Android进程</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="Android进程"><a href="#Android进程" class="headerlink" title="Android进程"></a>Android进程</h2><p><img src="/images/android/android_process.png" width="702" height="415" alt="process"></p>
<h3 id="1-进程和线程"><a href="#1-进程和线程" class="headerlink" title="1. 进程和线程"></a>1. 进程和线程</h3><h4 id="1-1-概念"><a href="#1-1-概念" class="headerlink" title="1.1 概念"></a>1.1 概念</h4><p>进程是表示资源分配的基本单位，又是调度运行的基本单位。<br>线程是进程中执行运算的最小单位，亦即执行处理机调度的基本单位。</p>
<h4 id="1-2-线程的好处"><a href="#1-2-线程的好处" class="headerlink" title="1.2 线程的好处"></a>1.2 线程的好处</h4><ol>
<li>开销少，易于调度。进程有自己的独立空间，线程可以共享同一进程的资源。切换和创建线程的开销比进程小。</li>
<li>提高并发性。通过线程可方便有效地实现并发性。进程可创建多个线程来执行同一程序的不同部分。</li>
<li>有利于充分发挥多处理器的功能。通过创建多线程，每个线程在一个处理器上运行，从而实现应用程序的并发性，使每个处理器都得到充分运行。</li>
</ol>
<h4 id="1-3-进程与线程的关系"><a href="#1-3-进程与线程的关系" class="headerlink" title="1.3 进程与线程的关系"></a>1.3 进程与线程的关系</h4><ol>
<li>一个进程可以有多个线程，但至少有一个线程；而一个线程只能在一个进程的地址空间内活动。</li>
<li>资源分配给进程，同一个进程的所有线程共享该进程所有资源。</li>
<li>CPU分配给线程，即真正在处理器运行的是线程。</li>
<li>线程在执行过程中需要协作同步，不同进程的线程间要利用消息通信的办法实现同步。</li>
</ol>
<h4 id="1-4-进程间通信的方式"><a href="#1-4-进程间通信的方式" class="headerlink" title="1.4 进程间通信的方式"></a>1.4 进程间通信的方式</h4><ol>
<li>管道-PIPE</li>
<li>命名管道-FIFO</li>
<li>信号 （signal）</li>
<li>消息队列（Message queues）</li>
<li>信号量（Semaphore）</li>
<li>共享内存（Share Memory）</li>
<li>内存映射（Memory Map）</li>
<li>套接字</li>
<li>Android实现的通信方式: Binder（算是内存映射的一种）</li>
</ol>
<ul>
<li>[ ] IPC</li>
<li>[ ] Binder</li>
</ul>
<h4 id="1-5-参考"><a href="#1-5-参考" class="headerlink" title="1.5 参考"></a>1.5 参考</h4><p>[<a href="https://www.cnblogs.com/losing-1216/p/5083097.html" target="_blank" rel="external">https://www.cnblogs.com/losing-1216/p/5083097.html</a>]</p>
<p>[<a href="https://www.cnblogs.com/zhuzhu2016/p/5804875.html" target="_blank" rel="external">https://www.cnblogs.com/zhuzhu2016/p/5804875.html</a>]</p>
<p>[<a href="https://www.cnblogs.com/chump-zwl/p/6962762.html" target="_blank" rel="external">https://www.cnblogs.com/chump-zwl/p/6962762.html</a>]</p>
<p>[<a href="https://blog.csdn.net/a987073381/article/details/52006729/" target="_blank" rel="external">https://blog.csdn.net/a987073381/article/details/52006729/</a>]</p>
<h3 id="2-Android进程级别"><a href="#2-Android进程级别" class="headerlink" title="2. Android进程级别"></a>2. Android进程级别</h3><ol>
<li>前台进程</li>
<li>可见进程</li>
<li>服务进程</li>
<li>后台进程</li>
<li>空进程</li>
</ol>
<h4 id="2-1-前台进程"><a href="#2-1-前台进程" class="headerlink" title="2.1 前台进程"></a>2.1 前台进程</h4><ol>
<li>拥有正在与用户交互的Activity</li>
<li>拥有如下情况的Service：</li>
</ol>
<ul>
<li>与1的Activity绑定的Service</li>
<li>前台服务，即调用了startForeground()</li>
<li>正在执行生命周期回调函数：onCreate()，onStartCommand()，onDestroy()</li>
</ul>
<ol>
<li>拥有一个正在执行onReceive()方法的BroadcastReceiver</li>
</ol>
<h4 id="2-2-可见进程"><a href="#2-2-可见进程" class="headerlink" title="2.2 可见进程"></a>2.2 可见进程</h4><ol>
<li>拥有一个Activity，这个Activity不在前台但是用户可见（onPause但是没有onStop）</li>
<li>拥有一个Service，这个Service与1的Activity绑定</li>
</ol>
<h4 id="2-3-服务进程"><a href="#2-3-服务进程" class="headerlink" title="2.3 服务进程"></a>2.3 服务进程</h4><p>持有一个正在运行的Service，这个Service不是前面两种情况</p>
<h4 id="2-4-后台进程"><a href="#2-4-后台进程" class="headerlink" title="2.4 后台进程"></a>2.4 后台进程</h4><p>如果进程不属于上面三种情况，但是进程持有一个用户不可见的activity（activity的onStop()被调用，但是onDestroy()没有调用的状态），就认为进程是一个后台进程</p>
<h4 id="2-5-空进程"><a href="#2-5-空进程" class="headerlink" title="2.5 空进程"></a>2.5 空进程</h4><p>如果一个进程不包含任何活跃的应用组件，则认为是空进程</p>
<p>保存这种进程的唯一理由是为了缓存的需要，为了加快下次要启动这个进程中的组件时的启动时间。系统为了平衡进程缓存和底层内核缓存的资源，经常会杀死空进程。</p>
<h4 id="2-6-参考"><a href="#2-6-参考" class="headerlink" title="2.6 参考"></a>2.6 参考</h4><p>[<a href="https://blog.csdn.net/bfboys/article/details/53957396" target="_blank" rel="external">https://blog.csdn.net/bfboys/article/details/53957396</a>]</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/">Android</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/进程/">进程</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/Android/">Android</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>











  
    <article id="post-BrocastReceiver" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/posts/BrocastReceiver/" class="article-date">
  	<time datetime="2018-08-05T02:53:56.000Z" itemprop="datePublished">2018-08-05</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/posts/BrocastReceiver/">Android Broadcast</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="Broadcast"><a href="#Broadcast" class="headerlink" title="Broadcast"></a>Broadcast</h2><p><img src="/images/broadcast/Broadcast.png" width="702" height="415" alt="Broadcast"></p>
<h3 id="1-分类"><a href="#1-分类" class="headerlink" title="1. 分类"></a>1. 分类</h3><ol>
<li>普通广播</li>
<li>有序广播</li>
<li>粘性广播</li>
<li>本地广播</li>
</ol>
<h4 id="1-1-普通广播"><a href="#1-1-普通广播" class="headerlink" title="1.1 普通广播"></a>1.1 普通广播</h4><p>发送：Context.sendBroadcast(Intent)<br>接收：Context.registerReceiver(BroadcastReceiver)</p>
<h4 id="1-2-有序广播"><a href="#1-2-有序广播" class="headerlink" title="1.2 有序广播"></a>1.2 有序广播</h4><p>发送：Context.sendOrderedBroadcast</p>
<p>接收是有序的，根据注册的接收器的优先级有序接收</p>
<h4 id="1-3-粘性广播"><a href="#1-3-粘性广播" class="headerlink" title="1.3 粘性广播"></a>1.3 粘性广播</h4><p>Android5.0 &amp; API 21中已经废弃</p>
<h4 id="1-4-本地广播"><a href="#1-4-本地广播" class="headerlink" title="1.4 本地广播"></a>1.4 本地广播</h4><p>使用LocalBroadcastManager发送和注册接收器，实现机制有其他广播有些不同。</p>
<h3 id="2-原理"><a href="#2-原理" class="headerlink" title="2. 原理"></a>2. 原理</h3><p>观察者模式，发布 / 订阅模型</p>
<p>广播可以归结为三个模块（步骤）：</p>
<ol>
<li>发布：发布广播</li>
<li>订阅：订阅处理相应关闭</li>
<li>调度中心：调用广播，将对应的广播分发给对应的订阅者，包括权限、action</li>
</ol>
<h4 id="2-1-非本地广播原理"><a href="#2-1-非本地广播原理" class="headerlink" title="2.1 非本地广播原理"></a>2.1 非本地广播原理</h4><p>AMS作为一个调度中心，通过它可以注册监听器，和发送广播，分发广播到监听器。这些步骤都是通过Binder机制进行交互。</p>
<p><img src="https://upload-images.jianshu.io/upload_images/944365-7c9ff656ebd1b981.png" alt="流程"></p>
<p>ps: 图片来源见参考链接</p>
<h4 id="2-2-本地广播原理"><a href="#2-2-本地广播原理" class="headerlink" title="2.2 本地广播原理"></a>2.2 本地广播原理</h4><p>将LocalBroadcastManager作为调度中心。是一个简单的实现类，不支持跨进程。</p>
<blockquote>
<p>ps:对于LocalBroadcastManager方式发送的应用内广播，只能通过LocalBroadcastManager动态注册，不能静态注册</p>
</blockquote>
<h3 id="3-注意"><a href="#3-注意" class="headerlink" title="3. 注意"></a>3. 注意</h3><ol>
<li>广播接收者的生命周期是非常短暂的，在接收到广播的时候创建，onReceive()方法结束之后销毁</li>
<li>广播接收者中不要执行耗时操作</li>
<li>广播接收者中不要创建子线程执行耗时操作，如果必须创建的话，需要配合goAsync方法使用</li>
<li>通过Service配合完成耗时操作</li>
</ol>
<h3 id="4-参考"><a href="#4-参考" class="headerlink" title="4. 参考"></a>4. 参考</h3><p><a href="https://www.jianshu.com/p/ca3d87a4cdf3" target="_blank" rel="external">https://www.jianshu.com/p/ca3d87a4cdf3</a></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/">Android</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Broadcast/">Broadcast</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/Android/">Android</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>











  
    <article id="post-Service" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/posts/Service/" class="article-date">
  	<time datetime="2018-08-04T13:53:56.000Z" itemprop="datePublished">2018-08-04</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/posts/Service/">Android Service</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="Service"><a href="#Service" class="headerlink" title="Service"></a>Service</h2><p><img src="/images/service/Service.png" width="702" height="415" alt="Service"></p>
<h3 id="1-概述"><a href="#1-概述" class="headerlink" title="1. 概述"></a>1. 概述</h3><p>Android四大组件之一，相对于Activity，Service一般用于执行：不和用户直接交互、具有较长运行时间的操作，或者为其他应用提供服务。</p>
<p>对Service我们要注意到：</p>
<ol>
<li>不是一个单独的进程，除非你特殊指定</li>
<li>不是一个线程，所以，如果需要进行耗时操作，需要开一个线程来完成。</li>
</ol>
<p>以此，Service其实很简单，它提供了前面我们说到的两个特征：</p>
<ol>
<li>执行一些需要在后台运行的长时间的操作，这个情况一般使用startService，Service会一直运行，直到操作完成或者被明确的结束</li>
<li>为其他应用(或者是自己)提供服务，这个情况一般使用bindService，建立一个长连接与Service进行交互</li>
</ol>
<p>这也引出Service的两种启动方式：startService和bindService</p>
<p>那么它们有什么区别？</p>
<ol>
<li>如前面所说，使用场景不同</li>
<li>生命周期不同</li>
</ol>
<h3 id="2-Service的通信（交互）"><a href="#2-Service的通信（交互）" class="headerlink" title="2. Service的通信（交互）"></a>2. Service的通信（交互）</h3><ol>
<li>通过事件</li>
<li>通过Binder</li>
</ol>
<h4 id="2-1-事件"><a href="#2-1-事件" class="headerlink" title="2.1 事件"></a>2.1 事件</h4><p>适用于startService，通过Intent进行数据（事件、消息）传入，通过事件发布进行数据（事件、消息）传出。</p>
<p>事件发布的形式：</p>
<ol>
<li>广播</li>
<li>事件总线</li>
</ol>
<h4 id="2-2-Binder"><a href="#2-2-Binder" class="headerlink" title="2.2. Binder"></a>2.2. Binder</h4><p>适用于bindService。通过ServiceConnection可以获取一个IBinder。</p>
<ol>
<li>本地服务（相同进程），可以通过IBinder直接获取Service实例进行交互</li>
<li>远程服务（不同进程），通过AIDL，AIDL还有一个简单的方式，不需要自己实现AIDL，就是Messenger，这是Android默认实现的一个AIDL</li>
</ol>
<p><a href="https://blog.csdn.net/lmj623565791/article/details/47017485" target="_blank" rel="external">https://blog.csdn.net/lmj623565791/article/details/47017485</a></p>
<h3 id="3-IntentService"><a href="#3-IntentService" class="headerlink" title="3. IntentService"></a>3. IntentService</h3><p>我们知道Service其实运行在主线程，但是我们需要进行耗时操作，那就需要在子线程中执行，所以便有了IntentService。</p>
<p>IntentService其实默认提供一个HandlerThread，和对应Handler，将onStartCommand传的Intent分发到Handler中处理，使用者只要简单的实现onHandleIntent进行处理就可以了。</p>
<h3 id="4-JobService"><a href="#4-JobService" class="headerlink" title="4. JobService"></a>4. JobService</h3><blockquote>
<p>有时候我们希望在特定情况下再启动事务，比如说延迟若干时间之后，或者等手机空闲了再运行，这样一方面不会在系统资源紧张之时喧宾夺主，另一方面也起到削峰填谷提高系统效率的作用。<br>Android从5.0开始，增加支持一种特殊的机制，即任务调度JobScheduler，该工具集成了常见的几种运行条件，开发者只需添加少数几行代码，即可完成原来要多种组件配合的工作。<br>任务调度机制由三个工具组成，首先是JobInfo，它指定了一个任务的概要信息，比如何时启动，启动时需要满足什么条件等等；其次是JobScheduler，它是系统提供的任务调度服务，它的实例从系统服务Context.JOB_SCHEDULER_SERVICE中获得；最后是JobService，它描述了该任务内部的具体业务逻辑，它的运行时刻由JobScheduler根据JobInfo指定的条件而计算决定</p>
</blockquote>
<h3 id="5-Service保活"><a href="#5-Service保活" class="headerlink" title="5. Service保活"></a>5. Service保活</h3><p>onStartCommand 三个返回值：</p>
<ol>
<li>START_NOT_STICKY：如果Service被系统杀掉之后，没有然后</li>
<li>START_STICKY：杀掉之后，会被安排重启，但是不会保存之前的Intent</li>
<li>START_REDELIVER_INTENT：保存之前的Intent</li>
</ol>
<p>其他：前台服务，进程相互唤醒，AlarmManager等</p>
<h3 id="6-Android进程级别"><a href="#6-Android进程级别" class="headerlink" title="6. Android进程级别"></a>6. Android进程级别</h3><ol>
<li>前台进程</li>
<li>可见进程</li>
<li>服务进程</li>
<li>后台进程</li>
<li>空进程</li>
</ol>
<ul>
<li>[ ] Android进程</li>
</ul>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/">Android</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Service/">Service</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/Android/">Android</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>











  
    <article id="post-snackbar" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/posts/snackbar/" class="article-date">
  	<time datetime="2017-05-16T12:31:30.000Z" itemprop="datePublished">2017-05-16</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/posts/snackbar/">snackbar</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="1-简介"><a href="#1-简介" class="headerlink" title="1.简介"></a>1.简介</h2><p>Snackbar是Android Support Design Library库中的一个控件，可以在屏幕底部快速弹出消息，并且提供一个按钮进行用户交互。本质上是在当前window上的一个ViewGroup（SnackbarLayout，继承至LinearLayout，包含一个TextView和Button）。</p>
<p>Snackbar相较于Toast，多了一个按钮与用户交互，较于Dialog，不中断用户的操作。</p>
<p>Snackbar位于com.android.support:design库的android.support.design.widget包下。</p>
<h2 id="2-使用"><a href="#2-使用" class="headerlink" title="2.使用"></a>2.使用</h2><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">dependencies &#123;</span><br><span class="line">	...</span><br><span class="line">	compile <span class="string">'com.android.support:design:25.0.1'</span></span><br><span class="line">	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> Snackbar snackbar = Snackbar.make(root, <span class="string">"这是一个Snackbar"</span>, <span class="number">10000</span>);</span><br><span class="line">snackbar.setAction(<span class="string">"知道了"</span>, <span class="keyword">new</span> View.OnClickListener() &#123;</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</span><br><span class="line">		snackbar.dismiss();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;);</span><br><span class="line">snackbar.show();</span><br></pre></td></tr></table></figure>
<h2 id="3-make方法"><a href="#3-make方法" class="headerlink" title="3.make方法"></a>3.make方法</h2><p>通过上面的使用，我们知道Snackbar的实例是通过make方法，那么，make方法是什么样子的呢？</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@NonNull</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Snackbar <span class="title">make</span><span class="params">(@NonNull View view, @NonNull CharSequence text,@Duration <span class="keyword">int</span> duration)</span> </span>&#123;</span><br><span class="line">   Snackbar snackbar = <span class="keyword">new</span> Snackbar(findSuitableParent(view));</span><br><span class="line">   snackbar.setText(text);</span><br><span class="line">   snackbar.setDuration(duration);</span><br><span class="line">   <span class="keyword">return</span> snackbar;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们发现make方法有三个参：view，text，duration。</p>
<ol>
<li>view ：通过findSuitableParent方法，传进view，找到一个适合的Snackbar的parent。findSuitableParent方法会找CoordinatorLayout<br>或者android.R.id.content(ContentParent)，哪个先找到使用哪个。具体可以看findSuitableParent方法。</li>
<li>text：需要展示的提示内容。</li>
<li>duration： 消息展示的时长，可以使用LENGTH_SHORT、LENGTH_LONG、LENGTH_INDEFINITE和具体的数值。分别对应的时长为短、长、无限和具体时间。</li>
</ol>
<h2 id="4-findSuitableParent方法"><a href="#4-findSuitableParent方法" class="headerlink" title="4.findSuitableParent方法"></a>4.findSuitableParent方法</h2><p>make方法中实例化Snackbar的时候需要findSuitableParent(view)方法找到Snackbar附着的parentview。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> ViewGroup <span class="title">findSuitableParent</span><span class="params">(View view)</span> </span>&#123;</span><br><span class="line">	ViewGroup fallback = <span class="keyword">null</span>;</span><br><span class="line">	do &#123;</span><br><span class="line">		<span class="keyword">if</span> (view <span class="keyword">instanceof</span> CoordinatorLayout) &#123;</span><br><span class="line">			<span class="comment">// We've found a CoordinatorLayout, use it</span></span><br><span class="line">			<span class="keyword">return</span> (ViewGroup) view;</span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (view <span class="keyword">instanceof</span> FrameLayout) &#123;</span><br><span class="line">			<span class="keyword">if</span> (view.getId() == android.R.id.content) &#123;</span><br><span class="line">				<span class="comment">// If we've hit the decor content view, then we didn't find a CoL in the</span></span><br><span class="line">				<span class="comment">// hierarchy, so use it.</span></span><br><span class="line">				<span class="keyword">return</span> (ViewGroup) view;</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				<span class="comment">// It's not the content view but we'll use it as our fallback</span></span><br><span class="line">				fallback = (ViewGroup) view;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">if</span> (view != <span class="keyword">null</span>) &#123;</span><br><span class="line">		<span class="comment">// Else, we will loop and crawl up the view hierarchy and try to find a parent</span></span><br><span class="line">			<span class="keyword">final</span> ViewParent parent = view.getParent();</span><br><span class="line">			view = parent <span class="keyword">instanceof</span> View ? (View) parent : <span class="keyword">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; <span class="keyword">while</span> (view != <span class="keyword">null</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// If we reach here then we didn't find a CoL or a suitable content view so we'll fallback</span></span><br><span class="line">	<span class="keyword">return</span> fallback;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过源码我们看到：</p>
<ol>
<li>只能是CoordinatorLayout或者FrameLayout</li>
<li>FrameLayout会先找id为android.R.id.content的view，即ContentParent</li>
<li>不是这两个就继续找他们的parent。</li>
</ol>
<h2 id="5-Snackbar构造"><a href="#5-Snackbar构造" class="headerlink" title="5.Snackbar构造"></a>5.Snackbar构造</h2><p>再让我们看看Snackbar是如何构造的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="title">Snackbar</span><span class="params">(ViewGroup parent)</span> </span>&#123;</span><br><span class="line">   mTargetParent = parent;</span><br><span class="line">   mContext = parent.getContext();</span><br><span class="line"></span><br><span class="line">   ThemeUtils.checkAppCompatTheme(mContext);</span><br><span class="line"></span><br><span class="line">   LayoutInflater inflater = LayoutInflater.from(mContext);</span><br><span class="line">   mView = (SnackbarLayout) inflater.inflate(</span><br><span class="line">           R.layout.design_layout_snackbar, mTargetParent, <span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">   mAccessibilityManager = (AccessibilityManager)</span><br><span class="line">           mContext.getSystemService(Context.ACCESSIBILITY_SERVICE);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们注意到在这里有个mView，是通过inflater获取到的，并且使用mTargetParent作为rootview，而这个mTargetParent就是通过findSuitableParent方法获取到的parentview。在后面我们可以知道这个mTargetParent将会add这个mView。<em>这个mView又是什么呢？</em></p>
<p>在show方法中我们可以知道这个mView其实就是这个Snackbar的布局，我们先看看design_layout_snackbar.xml这个布局文件。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span><br><span class="line">      <span class="attr">class</span>=<span class="string">"android.support.design.widget.Snackbar$SnackbarLayout"</span></span><br><span class="line">      <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></span><br><span class="line">      <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></span><br><span class="line">      <span class="attr">android:layout_gravity</span>=<span class="string">"bottom"</span></span><br><span class="line">      <span class="attr">android:theme</span>=<span class="string">"@style/ThemeOverlay.AppCompat.Dark"</span></span><br><span class="line">      <span class="attr">style</span>=<span class="string">"@style/Widget.Design.Snackbar"</span> /&gt;</span></span><br></pre></td></tr></table></figure>
<p>就是一个SnackbarLayout。那么还需要知道SnackbarLayout是什么。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">SnackbarLayout</span> <span class="keyword">extends</span> <span class="title">LinearLayout</span> </span>&#123;</span><br><span class="line">	...</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">SnackbarLayout</span><span class="params">(Context context, AttributeSet attrs)</span> </span>&#123;</span><br><span class="line">		...</span><br><span class="line">		LayoutInflater.from(context).inflate(R.layout.design_layout_snackbar_include, <span class="keyword">this</span>);</span><br><span class="line">		...</span><br><span class="line">		&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>还有布局文件design_layout_snackbar_include.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">merge</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">TextView</span></span><br><span class="line">            <span class="attr">android:id</span>=<span class="string">"@+id/snackbar_text"</span></span><br><span class="line">            <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></span><br><span class="line">            <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></span><br><span class="line">            <span class="attr">android:layout_weight</span>=<span class="string">"1"</span></span><br><span class="line">            <span class="attr">android:paddingTop</span>=<span class="string">"@dimen/design_snackbar_padding_vertical"</span></span><br><span class="line">            <span class="attr">android:paddingBottom</span>=<span class="string">"@dimen/design_snackbar_padding_vertical"</span></span><br><span class="line">            <span class="attr">android:paddingLeft</span>=<span class="string">"@dimen/design_snackbar_padding_horizontal"</span></span><br><span class="line">            <span class="attr">android:paddingRight</span>=<span class="string">"@dimen/design_snackbar_padding_horizontal"</span></span><br><span class="line">            <span class="attr">android:textAppearance</span>=<span class="string">"@style/TextAppearance.Design.Snackbar.Message"</span></span><br><span class="line">            <span class="attr">android:maxLines</span>=<span class="string">"@integer/design_snackbar_text_max_lines"</span></span><br><span class="line">            <span class="attr">android:layout_gravity</span>=<span class="string">"center_vertical|left|start"</span></span><br><span class="line">            <span class="attr">android:ellipsize</span>=<span class="string">"end"</span></span><br><span class="line">            <span class="attr">android:textAlignment</span>=<span class="string">"viewStart"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">Button</span></span><br><span class="line">            <span class="attr">android:id</span>=<span class="string">"@+id/snackbar_action"</span></span><br><span class="line">            <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></span><br><span class="line">            <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></span><br><span class="line">            <span class="attr">android:layout_marginLeft</span>=<span class="string">"@dimen/design_snackbar_extra_spacing_horizontal"</span></span><br><span class="line">            <span class="attr">android:layout_marginStart</span>=<span class="string">"@dimen/design_snackbar_extra_spacing_horizontal"</span></span><br><span class="line">            <span class="attr">android:layout_gravity</span>=<span class="string">"center_vertical|right|end"</span></span><br><span class="line">            <span class="attr">android:minWidth</span>=<span class="string">"48dp"</span></span><br><span class="line">            <span class="attr">android:visibility</span>=<span class="string">"gone"</span></span><br><span class="line">            <span class="attr">android:textColor</span>=<span class="string">"?attr/colorAccent"</span></span><br><span class="line">            <span class="attr">style</span>=<span class="string">"?attr/borderlessButtonStyle"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">merge</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>所以，SnackbarLayout是一个LinearLayout，并且包含一个TextView(MessageView)和一个Button(ActionView)。</p>
<p>同时我们还可以知道，setText就是设置这个MessageView，setAction就是设置这个Button。</p>
<h2 id="6-show方法"><a href="#6-show方法" class="headerlink" title="6.show方法"></a>6.show方法</h2><p>剩下的就是显示这个Snackbar了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">show</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   SnackbarManager.getInstance().show(mDuration, mManagerCallback);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Snackbar的show是通过SnackbarManager来完成的。来看看SnackbarManager：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> SnackbarManager sSnackbarManager;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> SnackbarManager <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   <span class="keyword">if</span> (sSnackbarManager == <span class="keyword">null</span>) &#123;</span><br><span class="line">       sSnackbarManager = <span class="keyword">new</span> SnackbarManager();</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> sSnackbarManager;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Object mLock;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Handler mHandler;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> SnackbarRecord mCurrentSnackbar;</span><br><span class="line"><span class="keyword">private</span> SnackbarRecord mNextSnackbar;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="title">SnackbarManager</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   mLock = <span class="keyword">new</span> Object();</span><br><span class="line">   mHandler = <span class="keyword">new</span> Handler(Looper.getMainLooper(), <span class="keyword">new</span> Handler.Callback() &#123;</span><br><span class="line">       <span class="meta">@Override</span></span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">handleMessage</span><span class="params">(Message message)</span> </span>&#123;</span><br><span class="line">           <span class="keyword">switch</span> (message.what) &#123;</span><br><span class="line">               <span class="keyword">case</span> MSG_TIMEOUT:</span><br><span class="line">                   handleTimeout((SnackbarRecord) message.obj);</span><br><span class="line">                   <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>SnackbarManager是一个单例，包含一个线程锁mLock，一个用来处理Snackbar超时的handler，以及两个Snackbar的记录实体SnackbarRecord，这个SnackbarRecord是这样的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">SnackbarRecord</span> </span>&#123;</span><br><span class="line">   <span class="keyword">final</span> WeakReference&lt;Callback&gt; callback;</span><br><span class="line">   <span class="keyword">int</span> duration;</span><br><span class="line"></span><br><span class="line">   SnackbarRecord(<span class="keyword">int</span> duration, Callback callback) &#123;</span><br><span class="line">       <span class="keyword">this</span>.callback = <span class="keyword">new</span> WeakReference&lt;&gt;(callback);</span><br><span class="line">       <span class="keyword">this</span>.duration = duration;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">boolean</span> <span class="title">isSnackbar</span><span class="params">(Callback callback)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">return</span> callback != <span class="keyword">null</span> &amp;&amp; <span class="keyword">this</span>.callback.get() == callback;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>SnackbarRecord是一个SnackbarManager的静态内部类，包含一个Callback的弱引用和一个Snackbar显示时间。<strong>注意这个Callback不是Snackbar的Callback而是SnackbarManager的Callback</strong>，用来执行显示和隐藏Snackbar的，在Snackbar的show方法中SnackbarManager.getInstance().show(mDuration, mManagerCallback);的mManagerCallback就是实现的这个Callback。具体的流程我们在下面还会进行总结的。</p>
<p>让我们在回到show方法中来，我们看看SnackbarManager的show方法的具体实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">show</span><span class="params">(<span class="keyword">int</span> duration, Callback callback)</span> </span>&#123;</span><br><span class="line">   <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">       <span class="keyword">if</span> (isCurrentSnackbarLocked(callback)) &#123;</span><br><span class="line">           <span class="comment">// Means that the callback is already in the queue. We'll just update the duration</span></span><br><span class="line">           mCurrentSnackbar.duration = duration;</span><br><span class="line"></span><br><span class="line">           <span class="comment">// If this is the Snackbar currently being shown, call re-schedule it's</span></span><br><span class="line">           <span class="comment">// timeout</span></span><br><span class="line">           mHandler.removeCallbacksAndMessages(mCurrentSnackbar);</span><br><span class="line">           scheduleTimeoutLocked(mCurrentSnackbar);</span><br><span class="line">           <span class="keyword">return</span>;</span><br><span class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isNextSnackbarLocked(callback)) &#123;</span><br><span class="line">           <span class="comment">// We'll just update the duration</span></span><br><span class="line">           mNextSnackbar.duration = duration;</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           <span class="comment">// Else, we need to create a new record and queue it</span></span><br><span class="line">           mNextSnackbar = <span class="keyword">new</span> SnackbarRecord(duration, callback);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (mCurrentSnackbar != <span class="keyword">null</span> &amp;&amp; cancelSnackbarLocked(mCurrentSnackbar,</span><br><span class="line">               Snackbar.Callback.DISMISS_EVENT_CONSECUTIVE)) &#123;</span><br><span class="line">           <span class="comment">// If we currently have a Snackbar, try and cancel it and wait in line</span></span><br><span class="line">           <span class="keyword">return</span>;</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           <span class="comment">// Clear out the current snackbar</span></span><br><span class="line">           mCurrentSnackbar = <span class="keyword">null</span>;</span><br><span class="line">           <span class="comment">// Otherwise, just show it now</span></span><br><span class="line">           showNextSnackbarLocked();</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该方法中先判断是否是当前Snackbar，如果是就修改一下隐藏时间（duration），重置隐藏的定时器。是否是下一个Snackbar，如果是就判断修改一下隐藏时间（duration）。其他情况就重新创建一个SnackbarRecord赋值给mNextSnackbar，即覆盖mNextSnackbar，也就是这个队列中只有两个SnackbarRecord，当前和下一个，如果传入多个Snackbar，最终</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>











  
    <article id="post-jdbc" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/posts/jdbc/" class="article-date">
  	<time datetime="2017-03-22T03:53:56.000Z" itemprop="datePublished">2017-03-22</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/posts/jdbc/">jdbc粗记</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="1-JDBC-最基本的连接"><a href="#1-JDBC-最基本的连接" class="headerlink" title="1.JDBC 最基本的连接"></a>1.JDBC 最基本的连接</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 测试jdbc连接mysql数据库</span><br><span class="line"> * </span><br><span class="line"> * @throws SQLException</span><br><span class="line"> */</span><br><span class="line">@Test</span><br><span class="line">public void test() throws SQLException &#123;</span><br><span class="line">	Driver driver = new Driver();// com.mysql.jdbc.Driver</span><br><span class="line">	String url = &quot;jdbc:mysql://127.0.0.1:3307/test&quot;;</span><br><span class="line">	Properties info = new Properties();</span><br><span class="line">	info.put(&quot;user&quot;, &quot;root&quot;);</span><br><span class="line">	info.put(&quot;password&quot;, &quot;root&quot;);</span><br><span class="line">	Connection conn = driver.connect(url, info);</span><br><span class="line">	System.out.println(conn);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过Driver获取Connection，使用Mysql的Driver可以连接到Mysql数据库。</p>
<h2 id="2-通过配置文件配置连接信息"><a href="#2-通过配置文件配置连接信息" class="headerlink" title="2.通过配置文件配置连接信息"></a>2.通过配置文件配置连接信息</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">public Connection getConnection()</span><br><span class="line">		throws SQLException, InstantiationException, IllegalAccessException, ClassNotFoundException, IOException &#123;</span><br><span class="line">	Driver driver = null;</span><br><span class="line">	String url = null;</span><br><span class="line">	String user = null;</span><br><span class="line">	String password = null;</span><br><span class="line">	String driverClassName = null;</span><br><span class="line"></span><br><span class="line">	InputStream is = getClass().getClassLoader().getResourceAsStream(&quot;db.properties&quot;);</span><br><span class="line">	Properties properties = new Properties();</span><br><span class="line">	properties.load(is);</span><br><span class="line">	url = properties.getProperty(&quot;jdbcUrl&quot;);</span><br><span class="line">	user = properties.getProperty(&quot;dbuser&quot;);</span><br><span class="line">	password = properties.getProperty(&quot;password&quot;);</span><br><span class="line">	driverClassName = properties.getProperty(&quot;driverClass&quot;);</span><br><span class="line"></span><br><span class="line">	System.out.println(&quot;url:&quot; + url);</span><br><span class="line">	System.out.println(&quot;user:&quot; + user);</span><br><span class="line">	System.out.println(&quot;password:&quot; + password);</span><br><span class="line">	System.out.println(&quot;driverClassName:&quot; + driverClassName);</span><br><span class="line"></span><br><span class="line">	driver = (Driver) Class.forName(driverClassName).newInstance();</span><br><span class="line">	Properties info = new Properties();</span><br><span class="line">	info.put(&quot;user&quot;, user);</span><br><span class="line">	info.put(&quot;password&quot;, password);</span><br><span class="line">	Connection conn = driver.connect(url, info);</span><br><span class="line">	return conn;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>db.properties内容为</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">dbuser=root</span><br><span class="line">password=root</span><br><span class="line">jdbcUrl=jdbc:mysql://127.0.0.1:3307/test</span><br><span class="line">driverClass=com.mysql.jdbc.Driver</span><br></pre></td></tr></table></figure>
<h2 id="3-通过DriverManager获取Connection"><a href="#3-通过DriverManager获取Connection" class="headerlink" title="3.通过DriverManager获取Connection"></a>3.通过DriverManager获取Connection</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">public Connection getConnectionFromDriverManager() throws Exception &#123;</span><br><span class="line">		String url = null;</span><br><span class="line">		String user = null;</span><br><span class="line">		String password = null;</span><br><span class="line">		String driverClassName = null;</span><br><span class="line"></span><br><span class="line">		InputStream is = getClass().getClassLoader().getResourceAsStream(&quot;db.properties&quot;);</span><br><span class="line">		Properties properties = new Properties();</span><br><span class="line">		properties.load(is);</span><br><span class="line">		url = properties.getProperty(&quot;jdbcUrl&quot;);</span><br><span class="line">		user = properties.getProperty(&quot;dbuser&quot;);</span><br><span class="line">		password = properties.getProperty(&quot;password&quot;);</span><br><span class="line">		driverClassName = properties.getProperty(&quot;driverClass&quot;);</span><br><span class="line"></span><br><span class="line">		System.out.println(&quot;url:&quot; + url);</span><br><span class="line">		System.out.println(&quot;user:&quot; + user);</span><br><span class="line">		System.out.println(&quot;password:&quot; + password);</span><br><span class="line">		System.out.println(&quot;driverClassName:&quot; + driverClassName);</span><br><span class="line"></span><br><span class="line">		// 注册驱动</span><br><span class="line">		// DriverManager.registerDriver(driver);</span><br><span class="line">		// 本来应该用这个方法实现，但是驱动的实现类里面有静态代码块已经实现这个</span><br><span class="line">		Class.forName(driverClassName);</span><br><span class="line"></span><br><span class="line">		Connection conn = DriverManager.getConnection(url, user, password);</span><br><span class="line">		return conn;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<h2 id="4-使用Statement进行操作"><a href="#4-使用Statement进行操作" class="headerlink" title="4.使用Statement进行操作"></a>4.使用Statement进行操作</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">public void update(String sql) &#123;</span><br><span class="line">	Connection conn = null;</span><br><span class="line">	Statement statement = null;</span><br><span class="line">	try &#123;</span><br><span class="line">		conn = JDBCTools.getConnection();</span><br><span class="line">		statement = conn.createStatement();</span><br><span class="line">		statement.executeUpdate(sql);</span><br><span class="line">	&#125; catch (Exception e) &#123;</span><br><span class="line">		e.printStackTrace();</span><br><span class="line">	&#125; finally &#123;</span><br><span class="line">		JDBCTools.release(null, statement, conn);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>执行更新。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">// 查询</span><br><span class="line">	@Test</span><br><span class="line">	public void query() &#123;</span><br><span class="line">		Connection conn = null;</span><br><span class="line">		Statement statement = null;</span><br><span class="line">		ResultSet result = null;</span><br><span class="line">		String sql = &quot;select * from customer;&quot;;</span><br><span class="line">		// String sql = &quot;select * from customer where id = 9;&quot;;</span><br><span class="line">		try &#123;</span><br><span class="line">			conn = JDBCTools.getConnection();</span><br><span class="line">			statement = conn.createStatement();</span><br><span class="line">			result = statement.executeQuery(sql);</span><br><span class="line">			while (result.next()) &#123;</span><br><span class="line">				int id = result.getInt(1);</span><br><span class="line">				String name = result.getString(2);</span><br><span class="line">				String email = result.getString(3);</span><br><span class="line">				Date birth = result.getDate(4);</span><br><span class="line">				System.out.println(&quot;id: &quot; + id);</span><br><span class="line">				System.out.println(&quot;name: &quot; + name);</span><br><span class="line">				System.out.println(&quot;email: &quot; + email);</span><br><span class="line">				System.out.println(&quot;date: &quot; + birth);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; catch (Exception e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; finally &#123;</span><br><span class="line">			JDBCTools.release(result, statement, conn);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>执行查询。结果在ResultSet中。</p>
<h2 id="5-使用PreparedStatement"><a href="#5-使用PreparedStatement" class="headerlink" title="5.使用PreparedStatement"></a>5.使用PreparedStatement</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">public void update(String sql, Object... args) &#123;</span><br><span class="line"></span><br><span class="line">	Connection conn = null;</span><br><span class="line">	PreparedStatement preparedStatement = null;</span><br><span class="line">	try &#123;</span><br><span class="line">		conn = JDBCTools.getConnection();</span><br><span class="line">		preparedStatement = conn.prepareStatement(sql);</span><br><span class="line">		for (int i = 0; i &lt; args.length; i++) &#123;</span><br><span class="line">			preparedStatement.setObject(i + 1, args[i]);</span><br><span class="line">		&#125;</span><br><span class="line">		preparedStatement.executeUpdate();</span><br><span class="line">	&#125; catch (Exception e) &#123;</span><br><span class="line">		e.printStackTrace();</span><br><span class="line">	&#125; finally &#123;</span><br><span class="line">		JDBCTools.release(null, preparedStatement, conn);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">public void addStudent2(Student stu) &#123;</span><br><span class="line">	String sql = &quot;insert into examstudent(type,idcard,examcard,studentname,location,grade) values (?,?,?,?,?,?);&quot;;</span><br><span class="line">	JDBCTools.update(sql, stu.getType(), stu.getIdCard(), stu.getExtramCard(), stu.getName(), stu.getLocation(),</span><br><span class="line">			stu.getGrade());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用PreparedStatement，sql可以使用占位符，避免拼接sql和sql注入，同时提高效率。</p>
<h2 id="6-ResultSet"><a href="#6-ResultSet" class="headerlink" title="6.ResultSet"></a>6.ResultSet</h2><p>执行查询会有结果返回，使用ResultSet。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">// 查询</span><br><span class="line">	@Test</span><br><span class="line">	public void query() &#123;</span><br><span class="line">		Connection conn = null;</span><br><span class="line">		Statement statement = null;</span><br><span class="line">		ResultSet result = null;</span><br><span class="line">		String sql = &quot;select * from customer;&quot;;</span><br><span class="line">		// String sql = &quot;select * from customer where id = 9;&quot;;</span><br><span class="line">		try &#123;</span><br><span class="line">			conn = JDBCTools.getConnection();</span><br><span class="line">			statement = conn.createStatement();</span><br><span class="line">			result = statement.executeQuery(sql);</span><br><span class="line">			while (result.next()) &#123;</span><br><span class="line">				int id = result.getInt(1);</span><br><span class="line">				String name = result.getString(2);</span><br><span class="line">				String email = result.getString(3);</span><br><span class="line">				Date birth = result.getDate(4);</span><br><span class="line">				System.out.println(&quot;id: &quot; + id);</span><br><span class="line">				System.out.println(&quot;name: &quot; + name);</span><br><span class="line">				System.out.println(&quot;email: &quot; + email);</span><br><span class="line">				System.out.println(&quot;date: &quot; + birth);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; catch (Exception e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; finally &#123;</span><br><span class="line">			JDBCTools.release(result, statement, conn);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>这个方法可以抽出来：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">public static &lt;T&gt; T query(Class&lt;T&gt; classz, String sql, Object... args) &#123;</span><br><span class="line">		Connection conn = null;</span><br><span class="line">		PreparedStatement statement = null;</span><br><span class="line">		ResultSet resultSet = null;</span><br><span class="line">		T entity = null;</span><br><span class="line">		try &#123;</span><br><span class="line">			conn = JDBCTools.getConnection();</span><br><span class="line">			statement = conn.prepareStatement(sql);</span><br><span class="line">			for (int i = 0; i &lt; args.length; i++) &#123;</span><br><span class="line">				statement.setObject((i + 1), args[i]);</span><br><span class="line">			&#125;</span><br><span class="line">			resultSet = statement.executeQuery();</span><br><span class="line">			ResultSetMetaData mt = resultSet.getMetaData();// 获取元信息，里面可以获取SQL字段别名</span><br><span class="line">			if (resultSet.next()) &#123;</span><br><span class="line">				entity = classz.newInstance();</span><br><span class="line">				for (int i = 0; i &lt; mt.getColumnCount(); i++) &#123;</span><br><span class="line">					String columnLabel = mt.getColumnLabel(i + 1);</span><br><span class="line">					Object value = resultSet.getObject(columnLabel);</span><br><span class="line">					// // 反射 赋值</span><br><span class="line">					// Field field = classz.getDeclaredField(columnLabel);</span><br><span class="line">					// field.setAccessible(true);</span><br><span class="line">					// field.set(entity, value);</span><br><span class="line">					BeanUtils.setProperty(entity, columnLabel, value);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; catch (Exception e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; finally &#123;</span><br><span class="line">			JDBCTools.release(resultSet, statement, conn);</span><br><span class="line">		&#125;</span><br><span class="line">		return entity;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>通过ResultSetMetaData可以获取ResultSet元信息，获取查询的字段的别名，通过别名与实体字段名对应，可以进行赋值。赋值有两种方式，通过反射和通过BeanUtils。</p>
<h2 id="7-获取自增主键值"><a href="#7-获取自增主键值" class="headerlink" title="7.获取自增主键值"></a>7.获取自增主键值</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">	 * 获取自增主键的值</span><br><span class="line">	 * </span><br><span class="line">	 * @throws Exception</span><br><span class="line">	 */</span><br><span class="line">	@Test</span><br><span class="line">	public void testGetAutoKeyValue() &#123;</span><br><span class="line">		Connection conn = null;</span><br><span class="line">		PreparedStatement preparedStatement = null;</span><br><span class="line">		ResultSet resultSet = null;</span><br><span class="line">		String sql = &quot;insert into customer(NAME,Email,birth) values(?,?,?)&quot;;</span><br><span class="line"></span><br><span class="line">		try &#123;</span><br><span class="line">			conn = JDBCTools.getConnection();</span><br><span class="line">			// 加这个</span><br><span class="line">			preparedStatement = conn.prepareStatement(sql, Statement.RETURN_GENERATED_KEYS);</span><br><span class="line">			preparedStatement.setString(1, &quot;啧啧&quot;);</span><br><span class="line">			preparedStatement.setString(2, &quot;xza@153.com&quot;);</span><br><span class="line">			preparedStatement.setDate(3, new Date(System.currentTimeMillis()));</span><br><span class="line">			preparedStatement.executeUpdate();</span><br><span class="line"></span><br><span class="line">			// 这样获取</span><br><span class="line">			resultSet = preparedStatement.getGeneratedKeys();</span><br><span class="line">			if (resultSet.next()) &#123;</span><br><span class="line">				System.out.println(&quot;==&gt;&quot; + resultSet.getInt(1));</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			// 字段名字 为 GENERATED_KEY</span><br><span class="line">			ResultSetMetaData md = resultSet.getMetaData();</span><br><span class="line">			for (int i = 0; i &lt; md.getColumnCount(); i++) &#123;</span><br><span class="line">				System.out.println(md.getColumnLabel(i + 1));</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">		&#125; catch (Exception e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; finally &#123;</span><br><span class="line">			JDBCTools.release(resultSet, preparedStatement, conn);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<h2 id="8-一个DAO"><a href="#8-一个DAO" class="headerlink" title="8.一个DAO"></a>8.一个DAO</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br></pre></td><td class="code"><pre><span class="line">package jdbc;</span><br><span class="line"></span><br><span class="line">import java.lang.reflect.Field;</span><br><span class="line">import java.lang.reflect.InvocationTargetException;</span><br><span class="line">import java.sql.Connection;</span><br><span class="line">import java.sql.PreparedStatement;</span><br><span class="line">import java.sql.ResultSet;</span><br><span class="line">import java.sql.ResultSetMetaData;</span><br><span class="line">import java.sql.SQLException;</span><br><span class="line">import java.util.ArrayList;</span><br><span class="line">import java.util.List;</span><br><span class="line"></span><br><span class="line">import org.apache.commons.beanutils.BeanUtils;</span><br><span class="line"></span><br><span class="line">// Data Access Object 数据访问对象</span><br><span class="line">public class Dao &#123;</span><br><span class="line"></span><br><span class="line">	public void update(String sql, Object... args) &#123;</span><br><span class="line"></span><br><span class="line">		Connection conn = null;</span><br><span class="line">		PreparedStatement preparedStatement = null;</span><br><span class="line">		try &#123;</span><br><span class="line">			conn = JDBCTools.getConnection();</span><br><span class="line">			preparedStatement = conn.prepareStatement(sql);</span><br><span class="line">			for (int i = 0; i &lt; args.length; i++) &#123;</span><br><span class="line">				preparedStatement.setObject(i + 1, args[i]);</span><br><span class="line">			&#125;</span><br><span class="line">			preparedStatement.executeUpdate();</span><br><span class="line">		&#125; catch (Exception e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; finally &#123;</span><br><span class="line">			JDBCTools.release(null, preparedStatement, conn);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	public &lt;T&gt; T query(Class&lt;T&gt; classz, String sql, Object... args) &#123;</span><br><span class="line">		// Connection conn = null;</span><br><span class="line">		// PreparedStatement preparedStatement = null;</span><br><span class="line">		// ResultSet resultSet = null;</span><br><span class="line">		// T entity = null;</span><br><span class="line">		// try &#123;</span><br><span class="line">		// conn = JDBCTools.getConnection();</span><br><span class="line">		// preparedStatement = conn.prepareStatement(sql);</span><br><span class="line">		// for (int i = 0; i &lt; args.length; i++) &#123;</span><br><span class="line">		// preparedStatement.setObject(i + 1, args[i]);</span><br><span class="line">		// &#125;</span><br><span class="line">		// resultSet = preparedStatement.executeQuery();</span><br><span class="line">		// if (resultSet.next()) &#123;</span><br><span class="line">		// entity = buildBean(classz, resultSet);</span><br><span class="line">		// &#125;</span><br><span class="line">		// &#125; catch (Exception e) &#123;</span><br><span class="line">		// e.printStackTrace();</span><br><span class="line">		// &#125; finally &#123;</span><br><span class="line">		// JDBCTools.release(resultSet, preparedStatement, conn);</span><br><span class="line">		// &#125;</span><br><span class="line">		// return entity;</span><br><span class="line">		List&lt;T&gt; list = queryAll(classz, sql, args);</span><br><span class="line">		if (list.size() &gt; 0) &#123;</span><br><span class="line">			return list.get(0);</span><br><span class="line">		&#125;</span><br><span class="line">		return null;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	public &lt;T&gt; List&lt;T&gt; queryAll(Class&lt;T&gt; classz, String sql, Object... args) &#123;</span><br><span class="line">		Connection conn = null;</span><br><span class="line">		PreparedStatement preparedStatement = null;</span><br><span class="line">		ResultSet resultSet = null;</span><br><span class="line">		List&lt;T&gt; list = null;</span><br><span class="line">		try &#123;</span><br><span class="line">			conn = JDBCTools.getConnection();</span><br><span class="line">			preparedStatement = conn.prepareStatement(sql);</span><br><span class="line">			for (int i = 0; i &lt; args.length; i++) &#123;</span><br><span class="line">				preparedStatement.setObject(i + 1, args[i]);</span><br><span class="line">			&#125;</span><br><span class="line">			resultSet = preparedStatement.executeQuery();</span><br><span class="line">			list = new ArrayList&lt;&gt;();</span><br><span class="line">			while (resultSet.next()) &#123;</span><br><span class="line">				list.add(buildBean(classz, resultSet));</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; catch (Exception e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; finally &#123;</span><br><span class="line">			JDBCTools.release(resultSet, preparedStatement, conn);</span><br><span class="line">		&#125;</span><br><span class="line">		return list;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@SuppressWarnings(&quot;unchecked&quot;)</span><br><span class="line">	public &lt;E&gt; E queryValue(String sql, Object... args) &#123;</span><br><span class="line"></span><br><span class="line">		Connection conn = null;</span><br><span class="line">		PreparedStatement preparedStatement = null;</span><br><span class="line">		ResultSet resultSet = null;</span><br><span class="line">		E value = null;</span><br><span class="line">		try &#123;</span><br><span class="line">			conn = JDBCTools.getConnection();</span><br><span class="line">			preparedStatement = conn.prepareStatement(sql);</span><br><span class="line">			for (int i = 0; i &lt; args.length; i++) &#123;</span><br><span class="line">				preparedStatement.setObject(i + 1, args[i]);</span><br><span class="line">			&#125;</span><br><span class="line">			resultSet = preparedStatement.executeQuery();</span><br><span class="line">			if (resultSet.next()) &#123;</span><br><span class="line">				value = (E) resultSet.getObject(1);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; catch (Exception e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; finally &#123;</span><br><span class="line">			JDBCTools.release(resultSet, preparedStatement, conn);</span><br><span class="line">		&#125;</span><br><span class="line">		return value;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	/**</span><br><span class="line">	 * 反射设置属性值</span><br><span class="line">	 * </span><br><span class="line">	 * @param classz</span><br><span class="line">	 * @param entity</span><br><span class="line">	 * @param columnLabel</span><br><span class="line">	 * @param obj</span><br><span class="line">	 * @throws NoSuchFieldException</span><br><span class="line">	 * @throws IllegalAccessException</span><br><span class="line">	 * @deprecated 使用BeanUtils代替</span><br><span class="line">	 */</span><br><span class="line">	@Deprecated</span><br><span class="line">	public &lt;T&gt; void setProperty(Class&lt;T&gt; classz, T entity, String columnLabel, Object obj)</span><br><span class="line">			throws NoSuchFieldException, IllegalAccessException &#123;</span><br><span class="line">		Field field = classz.getDeclaredField(columnLabel);</span><br><span class="line">		field.setAccessible(true);</span><br><span class="line">		field.set(entity, obj);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	/**</span><br><span class="line">	 * 组装Bean</span><br><span class="line">	 * </span><br><span class="line">	 * @param classz</span><br><span class="line">	 * @param resultSet</span><br><span class="line">	 * @return</span><br><span class="line">	 * @throws InstantiationException</span><br><span class="line">	 * @throws IllegalAccessException</span><br><span class="line">	 * @throws SQLException</span><br><span class="line">	 * @throws InvocationTargetException</span><br><span class="line">	 */</span><br><span class="line">	private &lt;T&gt; T buildBean(Class&lt;T&gt; classz, ResultSet resultSet)</span><br><span class="line">			throws InstantiationException, IllegalAccessException, SQLException, InvocationTargetException &#123;</span><br><span class="line">		T entity = classz.newInstance();</span><br><span class="line">		ResultSetMetaData mt = resultSet.getMetaData();</span><br><span class="line">		int columnCount = mt.getColumnCount();</span><br><span class="line">		for (int i = 0; i &lt; columnCount; i++) &#123;</span><br><span class="line">			String columnLabel = mt.getColumnLabel(i + 1);</span><br><span class="line">			Object obj = resultSet.getObject(columnLabel);</span><br><span class="line"></span><br><span class="line">			// setProperty(classz, entity, columnLabel, obj);</span><br><span class="line">			BeanUtils.setProperty(entity, columnLabel, obj);</span><br><span class="line">		&#125;</span><br><span class="line">		return entity;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="9-事务"><a href="#9-事务" class="headerlink" title="9.事务"></a>9.事务</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">public static void commit(Connection connection) &#123;</span><br><span class="line">		if (connection != null) &#123;</span><br><span class="line">			try &#123;</span><br><span class="line">				connection.commit();</span><br><span class="line">			&#125; catch (SQLException e) &#123;</span><br><span class="line">				e.printStackTrace();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	public static void rollback(Connection connection) &#123;</span><br><span class="line">		if (connection != null) &#123;</span><br><span class="line">			try &#123;</span><br><span class="line">				connection.rollback();</span><br><span class="line">			&#125; catch (SQLException e) &#123;</span><br><span class="line">				e.printStackTrace();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	public static void beginTx(Connection connection) &#123;</span><br><span class="line">		if (connection != null) &#123;</span><br><span class="line">			try &#123;</span><br><span class="line">				connection.setAutoCommit(false);</span><br><span class="line">			&#125; catch (SQLException e) &#123;</span><br><span class="line">				e.printStackTrace();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// 设置事物的隔离级别，还可以设置Mysql数据库的全局</span><br><span class="line">conn.setTransactionIsolation(Connection.TRANSACTION_READ_COMMITTED);</span><br></pre></td></tr></table></figure>
<h2 id="10-批处理"><a href="#10-批处理" class="headerlink" title="10.批处理"></a>10.批处理</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">statement.addBatch();</span><br><span class="line">if ((i + 1) % 600 == 0) &#123;</span><br><span class="line">	statement.executeBatch();</span><br><span class="line">	statement.clearBatch();</span><br><span class="line">&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<h2 id="11-连接池"><a href="#11-连接池" class="headerlink" title="11.连接池"></a>11.连接池</h2><p>两种方式C3p0、dbcp</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 连接池 测试</span><br><span class="line"> */</span><br><span class="line">public class DateSourceTest &#123;</span><br><span class="line">	</span><br><span class="line">	/**</span><br><span class="line">	 * http://www.mchange.com/projects/c3p0/#per-user_configurations</span><br><span class="line">	 * @throws PropertyVetoException</span><br><span class="line">	 * @throws SQLException</span><br><span class="line">	 */</span><br><span class="line">	@Test</span><br><span class="line">	public void testC3p0XmlConfig() throws PropertyVetoException, SQLException&#123;</span><br><span class="line">		ComboPooledDataSource cpds = new ComboPooledDataSource(&quot;helloC3p0&quot;);// c3p0-config.xml中设置的</span><br><span class="line">		</span><br><span class="line">		Connection conn = cpds.getConnection();</span><br><span class="line">		System.out.println(conn);</span><br><span class="line">		conn.close();</span><br><span class="line">		</span><br><span class="line">		cpds.close();</span><br><span class="line">	&#125;</span><br><span class="line">	@Test</span><br><span class="line">	public void testC3p0() throws PropertyVetoException, SQLException&#123;</span><br><span class="line">		ComboPooledDataSource cpds = new ComboPooledDataSource();</span><br><span class="line">		cpds.setDriverClass( &quot;com.mysql.jdbc.Driver&quot; ); //loads the jdbc driver            </span><br><span class="line">		cpds.setJdbcUrl( &quot;jdbc:mysql://localhost:3307/test&quot; );//jdbc:mysql://127.0.0.1:3307/test</span><br><span class="line">		cpds.setUser(&quot;root&quot;);                                  </span><br><span class="line">		cpds.setPassword(&quot;root&quot;);   </span><br><span class="line">		</span><br><span class="line">		Connection conn = cpds.getConnection();</span><br><span class="line">		System.out.println(conn);</span><br><span class="line">		conn.close();</span><br><span class="line">		</span><br><span class="line">		cpds.close();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	/**</span><br><span class="line">	 * 使用配置文件</span><br><span class="line">	 * 注意key为属性名字</span><br><span class="line">	 * </span><br><span class="line">	 * @throws Exception</span><br><span class="line">	 */</span><br><span class="line">	@Test</span><br><span class="line">	public void testDateSourceWithFactory() throws Exception &#123;</span><br><span class="line">		BasicDataSource dataSource = null;</span><br><span class="line"></span><br><span class="line">		InputStream is = JDBCTools.class.getClassLoader().getResourceAsStream(&quot;dbcp.properties&quot;);</span><br><span class="line">		Properties properties = new Properties();</span><br><span class="line">		properties.load(is);</span><br><span class="line"></span><br><span class="line">		dataSource = BasicDataSourceFactory.createDataSource(properties);</span><br><span class="line"></span><br><span class="line">		Connection conn = dataSource.getConnection();</span><br><span class="line"></span><br><span class="line">		System.out.println(conn);</span><br><span class="line"></span><br><span class="line">		dataSource.close();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@Test</span><br><span class="line">	public void testDateSource() throws SQLException, IOException &#123;</span><br><span class="line">		BasicDataSource dataSource = null;</span><br><span class="line">		dataSource = new BasicDataSource();</span><br><span class="line"></span><br><span class="line">		InputStream is = JDBCTools.class.getClassLoader().getResourceAsStream(&quot;db.properties&quot;);</span><br><span class="line">		Properties properties = new Properties();</span><br><span class="line">		properties.load(is);</span><br><span class="line"></span><br><span class="line">		String url = properties.getProperty(&quot;jdbcUrl&quot;);</span><br><span class="line">		String username = properties.getProperty(&quot;dbuser&quot;);</span><br><span class="line">		String password = properties.getProperty(&quot;password&quot;);</span><br><span class="line">		String driverClassName = properties.getProperty(&quot;driverClass&quot;);</span><br><span class="line"></span><br><span class="line">		// 设置属性</span><br><span class="line">		dataSource.setUsername(username);</span><br><span class="line">		dataSource.setPassword(password);</span><br><span class="line">		dataSource.setUrl(url);</span><br><span class="line">		dataSource.setDriverClassName(driverClassName);</span><br><span class="line"></span><br><span class="line">		// 设置初始化大小？</span><br><span class="line">		dataSource.setInitialSize(5);</span><br><span class="line">		// 设置做大数量？</span><br><span class="line">		dataSource.setMaxTotal(10);</span><br><span class="line">		// 设置最小空闲数量</span><br><span class="line">		dataSource.setMinIdle(5);</span><br><span class="line">		// 设置最长等待分配连接时长</span><br><span class="line">		dataSource.setMaxWaitMillis(5 * 1000);</span><br><span class="line"></span><br><span class="line">		Connection conn = dataSource.getConnection();</span><br><span class="line"></span><br><span class="line">		System.out.println(conn);</span><br><span class="line"></span><br><span class="line">		dataSource.close();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>dbcp.properties:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">username=root</span><br><span class="line">password=root</span><br><span class="line">driverClassName=com.mysql.jdbc.Driver</span><br><span class="line">url=jdbc:mysql://127.0.0.1:3307/test</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">initialSize=10</span><br><span class="line">maxTotal=50</span><br><span class="line">minIdle=5</span><br><span class="line">maxWaitMillis=5000</span><br></pre></td></tr></table></figure>
<p>c3p0-config.xml:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&lt;c3p0-config&gt;</span><br><span class="line"></span><br><span class="line">	&lt;named-config name=&quot;helloC3p0&quot;&gt;</span><br><span class="line">		&lt;!-- 连接的基本属性 --&gt;</span><br><span class="line">		&lt;property name=&quot;user&quot;&gt;root&lt;/property&gt;</span><br><span class="line">		&lt;property name=&quot;password&quot;&gt;root&lt;/property&gt;</span><br><span class="line">		&lt;property name=&quot;driverClass&quot;&gt;com.mysql.jdbc.Driver&lt;/property&gt;</span><br><span class="line">		&lt;property name=&quot;jdbcUrl&quot;&gt;jdbc:mysql://127.0.0.1:3307/test&lt;/property&gt;</span><br><span class="line"></span><br><span class="line">		&lt;!-- 数据库中连接数不足时，一次向连接池添加连接的数量 --&gt;</span><br><span class="line">		&lt;property name=&quot;acquireIncrement&quot;&gt;5&lt;/property&gt;</span><br><span class="line">		&lt;property name=&quot;initialPoolSize&quot;&gt;10&lt;/property&gt;</span><br><span class="line">		&lt;property name=&quot;minPoolSize&quot;&gt;5&lt;/property&gt;</span><br><span class="line">		&lt;property name=&quot;maxPoolSize&quot;&gt;100&lt;/property&gt;</span><br><span class="line"></span><br><span class="line">		&lt;!-- 连接池可维护的Statement数量 --&gt;</span><br><span class="line">		&lt;property name=&quot;maxStatements&quot;&gt;20&lt;/property&gt;</span><br><span class="line">		&lt;!-- 每个连接同时可以使用的Statement的个数 --&gt;</span><br><span class="line">		&lt;property name=&quot;maxStatementsPerConnection&quot;&gt;5&lt;/property&gt;</span><br><span class="line"></span><br><span class="line">	&lt;/named-config&gt;</span><br><span class="line">&lt;/c3p0-config&gt;</span><br></pre></td></tr></table></figure>
<h2 id="12-BeanUtils"><a href="#12-BeanUtils" class="headerlink" title="12.BeanUtils"></a>12.BeanUtils</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">public class DbUtilTest &#123;</span><br><span class="line"></span><br><span class="line">	@Test</span><br><span class="line">	public void dbUtilQuery() &#123;</span><br><span class="line">		QueryRunner queryRunner = new QueryRunner();</span><br><span class="line">		Connection conn = null;</span><br><span class="line">		String sql = &quot;select id,name,email,birth from customer where id =?;&quot;;</span><br><span class="line">		try &#123;</span><br><span class="line">			conn = JDBCTools.getConnection();</span><br><span class="line">			Customer customer = queryRunner.query(conn, sql, new BeanHandler&lt;Customer&gt;(Customer.class), 700344);</span><br><span class="line">			System.out.println(customer);</span><br><span class="line">		&#125; catch (SQLException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; finally &#123;</span><br><span class="line">			JDBCTools.release(null, null, conn);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@Test</span><br><span class="line">	public void dbUtilQueryList() &#123;</span><br><span class="line">		QueryRunner queryRunner = new QueryRunner();</span><br><span class="line">		Connection conn = null;</span><br><span class="line">		String sql = &quot;select id,name,email,birth from customer where id in(?,?);&quot;;</span><br><span class="line">		try &#123;</span><br><span class="line">			conn = JDBCTools.getConnection();</span><br><span class="line">			List&lt;Customer&gt; customers = queryRunner.query(conn, sql, new BeanListHandler&lt;Customer&gt;(Customer.class),</span><br><span class="line">					700344, 700343);</span><br><span class="line">			System.out.println(customers);</span><br><span class="line">		&#125; catch (SQLException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; finally &#123;</span><br><span class="line">			JDBCTools.release(null, null, conn);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@Test</span><br><span class="line">	public void dbUtilUpdate() &#123;</span><br><span class="line">		QueryRunner queryRunner = new QueryRunner();</span><br><span class="line">		Connection conn = null;</span><br><span class="line">		String sql = &quot;Delete from customer where id in(?,?);&quot;;</span><br><span class="line">		try &#123;</span><br><span class="line">			conn = JDBCTools.getConnection();</span><br><span class="line">			queryRunner.update(conn, sql, 700346, 700345);</span><br><span class="line">		&#125; catch (SQLException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; finally &#123;</span><br><span class="line">			JDBCTools.release(null, null, conn);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>解析数据到实体是通过Handler。相关的Handler有BeanHandler、BeanListHandler、ScalarHandler、MapHandler、MapListHandler等。</p>
<h2 id="13-DAO"><a href="#13-DAO" class="headerlink" title="13.DAO"></a>13.DAO</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 在之前的基础上抽象一个DAO接口</span><br><span class="line"> */</span><br><span class="line">public interface Dao&lt;T&gt; &#123;</span><br><span class="line"></span><br><span class="line">	T query(Connection connection, String sql, Object... agrs) throws SQLException;</span><br><span class="line"></span><br><span class="line">	&lt;E&gt; E queryVaule(Connection connection, String sql, Object... agrs);</span><br><span class="line"></span><br><span class="line">	List&lt;T&gt; queryList(Connection connection, String sql, Object... agrs);</span><br><span class="line"></span><br><span class="line">	void update(Connection connection, String sql, Object... agrs);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 使用DbUtil的QueryRunner实现的DAO</span><br><span class="line"> */</span><br><span class="line">public class DbUtilDaoImpl&lt;T&gt; implements Dao&lt;T&gt; &#123;</span><br><span class="line"></span><br><span class="line">	private QueryRunner mQueryRunner;</span><br><span class="line">	private Class&lt;T&gt; type;</span><br><span class="line"></span><br><span class="line">	public DbUtilDaoImpl() &#123;</span><br><span class="line">		mQueryRunner = new QueryRunner();</span><br><span class="line">		type = ReflectionUtils.getSuperGenericType(getClass());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@Override</span><br><span class="line">	public T query(Connection connection, String sql, Object... args) throws SQLException &#123;</span><br><span class="line">		return mQueryRunner.query(connection, sql, new BeanHandler&lt;T&gt;(type), args);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@Override</span><br><span class="line">	public &lt;E&gt; E queryVaule(Connection connection, String sql, Object... agrs) &#123;</span><br><span class="line">		// TODO Auto-generated method stub</span><br><span class="line">		return null;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@Override</span><br><span class="line">	public List&lt;T&gt; queryList(Connection connection, String sql, Object... agrs) &#123;</span><br><span class="line">		// TODO Auto-generated method stub</span><br><span class="line">		return null;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@Override</span><br><span class="line">	public void update(Connection connection, String sql, Object... agrs) &#123;</span><br><span class="line">		// TODO Auto-generated method stub</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * Customer的DAO</span><br><span class="line"> * </span><br><span class="line"> * 继承DbUtilDaoImpl，还未做其他实现</span><br><span class="line"> */</span><br><span class="line">public class CustomerDao extends DbUtilDaoImpl&lt;Customer&gt; &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">public class CustomerDaoTest &#123;</span><br><span class="line"></span><br><span class="line">	private CustomerDao dao = new CustomerDao();</span><br><span class="line"></span><br><span class="line">	@Test</span><br><span class="line">	public void testQuery() &#123;</span><br><span class="line">		Connection conn = null;</span><br><span class="line">		String sql = &quot;select id,name,email,birth from customer where id = ?&quot;;</span><br><span class="line">		try &#123;</span><br><span class="line">			conn = JDBCTools.getConnection();</span><br><span class="line">			Customer customer = dao.query(conn, sql, 700344);</span><br><span class="line">			System.out.println(customer);</span><br><span class="line">		&#125; catch (SQLException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; finally &#123;</span><br><span class="line">			JDBCTools.release(null, null, conn);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@Test</span><br><span class="line">	public void testQueryVaule() &#123;</span><br><span class="line">		fail(&quot;Not yet implemented&quot;);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@Test</span><br><span class="line">	public void testQueryList() &#123;</span><br><span class="line">		fail(&quot;Not yet implemented&quot;);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@Test</span><br><span class="line">	public void testUpdate() &#123;</span><br><span class="line">		fail(&quot;Not yet implemented&quot;);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Java/">Java</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/Java/">Java</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>











  
    <article id="post-byteCode" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/posts/byteCode/" class="article-date">
  	<time datetime="2016-12-14T02:12:55.000Z" itemprop="datePublished">2016-12-14</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/posts/byteCode/">初识Java字节码</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="1-Class-文件结构"><a href="#1-Class-文件结构" class="headerlink" title="1. Class 文件结构"></a>1. Class 文件结构</h2><p>Class文件是一组以8字节为基础单位的二进制流，各个数据项目严格按照顺序紧凑排列在Class文件中，中间没有分隔符。如果遇到需要占用超过8个字节的数据项目时，会按照高位在前（big-endian order，大端序）的方式分割成若干个8位字节进行存储。</p>
<p>Class文件格式采用一种类似于C语言结构体的伪结构来存储，这种伪结构中只有两种数据类型：无符号数和表。</p>
<p>无符号数就是u1、u2、u4、u8来分别代表1个、2个、4个、8个字节。无符号数可以用来描述数字、索引引用、数量值或者按照UTF-8编码构成字符串值。</p>
<p>表是由多个无符号数或其他表作为数据项构成的复合数据类型，以“_info”结尾。在表开始位置，通常会使用一个前置的容量计数器，因为表通常要描述数量不定的多个数据。</p>
<p>下图（表）就是我们来看看Class文件的结构：</p>
<p><img src="/images/bytecode/Class_file.png" width="809" height="867" alt="Class文件结构"></p>
<p>然后，我们通过一个简单例子来认识一下Class文件结构。</p>
<h2 id="2-简单例子"><a href="#2-简单例子" class="headerlink" title="2. 简单例子"></a>2. 简单例子</h2><p>java代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.qinglinyi.demo;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ByteCodeSample</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String msg = <span class="string">"hello world"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">say</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(msg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>文件位置：</p>
<p><img src="/images/bytecode/java_package.png" width="600" alt="java文件位置"></p>
<p>编译之后生成ByteCodeSample.class，使用sublime打开可以看到这些二进制流：</p>
<p><img src="/images/bytecode/class_byte_code.png" width="300" height="300" alt="class文件二进制流"></p>
<p>使用javap之后：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">  Last modified Nov 16, 2016; size 585 bytes</span><br><span class="line">  MD5 checksum 05f97704a322e75b8e3635f42ddf83c8</span><br><span class="line">  Compiled from "ByteCodeSample.java"</span><br><span class="line">public class com.qinglinyi.demo.ByteCodeSample</span><br><span class="line">  minor version: 0</span><br><span class="line">  major version: 52</span><br><span class="line">  flags: ACC_PUBLIC, ACC_SUPER</span><br><span class="line">Constant pool:</span><br><span class="line">   #1 = Methodref          #7.#20         // java/lang/Object."&lt;init&gt;":()V</span><br><span class="line">   #2 = String             #21            // hello world</span><br><span class="line">   #3 = Fieldref           #6.#22         // com/qinglinyi/demo/ByteCodeSample.msg:Ljava/lang/String;</span><br><span class="line">   #4 = Fieldref           #23.#24        // java/lang/System.out:Ljava/io/PrintStream;</span><br><span class="line">   #5 = Methodref          #25.#26        // java/io/PrintStream.println:(Ljava/lang/String;)V</span><br><span class="line">   #6 = Class              #27            // com/qinglinyi/demo/ByteCodeSample</span><br><span class="line">   #7 = Class              #28            // java/lang/Object</span><br><span class="line">   #8 = Utf8               msg</span><br><span class="line">   #9 = Utf8               Ljava/lang/String;</span><br><span class="line">  #10 = Utf8               &lt;init&gt;</span><br><span class="line">  #11 = Utf8               ()V</span><br><span class="line">  #12 = Utf8               Code</span><br><span class="line">  #13 = Utf8               LineNumberTable</span><br><span class="line">  #14 = Utf8               LocalVariableTable</span><br><span class="line">  #15 = Utf8               this</span><br><span class="line">  #16 = Utf8               Lcom/qinglinyi/demo/ByteCodeSample;</span><br><span class="line">  #17 = Utf8               say</span><br><span class="line">  #18 = Utf8               SourceFile</span><br><span class="line">  #19 = Utf8               ByteCodeSample.java</span><br><span class="line">  #20 = NameAndType        #10:#11        // "&lt;init&gt;":()V</span><br><span class="line">  #21 = Utf8               hello world</span><br><span class="line">  #22 = NameAndType        #8:#9          // msg:Ljava/lang/String;</span><br><span class="line">  #23 = Class              #29            // java/lang/System</span><br><span class="line">  #24 = NameAndType        #30:#31        // out:Ljava/io/PrintStream;</span><br><span class="line">  #25 = Class              #32            // java/io/PrintStream</span><br><span class="line">  #26 = NameAndType        #33:#34        // println:(Ljava/lang/String;)V</span><br><span class="line">  #27 = Utf8               com/qinglinyi/demo/ByteCodeSample</span><br><span class="line">  #28 = Utf8               java/lang/Object</span><br><span class="line">  #29 = Utf8               java/lang/System</span><br><span class="line">  #30 = Utf8               out</span><br><span class="line">  #31 = Utf8               Ljava/io/PrintStream;</span><br><span class="line">  #32 = Utf8               java/io/PrintStream</span><br><span class="line">  #33 = Utf8               println</span><br><span class="line">  #34 = Utf8               (Ljava/lang/String;)V</span><br><span class="line">&#123;</span><br><span class="line">  public com.qinglinyi.demo.ByteCodeSample();</span><br><span class="line">    descriptor: ()V</span><br><span class="line">    flags: ACC_PUBLIC</span><br><span class="line">    Code:</span><br><span class="line">      stack=2, locals=1, args_size=1</span><br><span class="line">         0: aload_0</span><br><span class="line">         1: invokespecial #1                  // Method java/lang/Object."&lt;init&gt;":()V</span><br><span class="line">         4: aload_0</span><br><span class="line">         5: ldc           #2                  // String hello world</span><br><span class="line">         7: putfield      #3                  // Field msg:Ljava/lang/String;</span><br><span class="line">        10: return</span><br><span class="line">      LineNumberTable:</span><br><span class="line">        line 4: 0</span><br><span class="line">        line 6: 4</span><br><span class="line">      LocalVariableTable:</span><br><span class="line">        Start  Length  Slot  Name   Signature</span><br><span class="line">            0      11     0  this   Lcom/qinglinyi/demo/ByteCodeSample;</span><br><span class="line"></span><br><span class="line">  public void say();</span><br><span class="line">    descriptor: ()V</span><br><span class="line">    flags: ACC_PUBLIC</span><br><span class="line">    Code:</span><br><span class="line">      stack=2, locals=1, args_size=1</span><br><span class="line">         0: getstatic     #4                  // Field java/lang/System.out:Ljava/io/PrintStream;</span><br><span class="line">         3: aload_0</span><br><span class="line">         4: getfield      #3                  // Field msg:Ljava/lang/String;</span><br><span class="line">         7: invokevirtual #5                  // Method java/io/PrintStream.println:(Ljava/lang/String;)V</span><br><span class="line">        10: return</span><br><span class="line">      LineNumberTable:</span><br><span class="line">        line 9: 0</span><br><span class="line">        line 10: 10</span><br><span class="line">      LocalVariableTable:</span><br><span class="line">        Start  Length  Slot  Name   Signature</span><br><span class="line">            0      11     0  this   Lcom/qinglinyi/demo/ByteCodeSample;</span><br><span class="line">&#125;</span><br><span class="line">SourceFile: "ByteCodeSample.java"</span><br></pre></td></tr></table></figure>
<p>对这个二进制进行分析，找出对应的数据项：</p>
<p><img src="/images/bytecode/class_byte_code_info_1.png" alt="class文件二进制流介绍"></p>
<p><img src="/images/bytecode/class_byte_code_info_2.png" alt="class文件二进制流介绍"></p>
<p>接着，我们逐项分析</p>
<h2 id="3-魔数（u4-magic）"><a href="#3-魔数（u4-magic）" class="headerlink" title="3. 魔数（u4: magic）"></a>3. 魔数（u4: magic）</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ca fe ba be</span><br></pre></td></tr></table></figure>
<p>用来标记这个文件是否是一个Class文件。</p>
<h2 id="4-版本（u2-minor-version，u2-major-version）"><a href="#4-版本（u2-minor-version，u2-major-version）" class="headerlink" title="4. 版本（u2: minor_version，u2: major_version）"></a>4. 版本（u2: minor_version，u2: major_version）</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">34</span></span><br></pre></td></tr></table></figure>
<p>次版本号（minor_version）= 0（十进制）<br>主版本号（major_version）= 52（十进制）</p>
<p>所以这个Class文件的格式版本号为52.0</p>
<h2 id="5-常量池计数器-（u2-constant-pool-count）"><a href="#5-常量池计数器-（u2-constant-pool-count）" class="headerlink" title="5. 常量池计数器 （u2: constant_pool_count）"></a>5. 常量池计数器 （u2: constant_pool_count）</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00</span> <span class="number">23</span></span><br></pre></td></tr></table></figure>
<p>标记常量池表的数量，值等于constant_pool表中的成员数加1。本例中值为23（对应的十进制为35）</p>
<h2 id="6-常量池（cp-info-constant-pool）"><a href="#6-常量池（cp-info-constant-pool）" class="headerlink" title="6. 常量池（cp_info: constant_pool）"></a>6. 常量池（cp_info: constant_pool）</h2><p>所有的常量池项都具有如下通用格式: </p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">cp_info &#123;</span><br><span class="line">	u1 tag;</span><br><span class="line">	u1 info[]; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>常量池中，每个cp_info项的格式必须相同，它们都以一个表示cp_info类型的单字节 “tag”项开头。后面 info[]项的内容tag由的类型所决定。每个tag项必须跟随2个或更多的字节，这些字节用于给定这个常量的信息，附加字节的信息格式由tag的值决定。 </p>
<table>
<thead>
<tr>
<th style="text-align:center">类型</th>
<th style="text-align:center">值</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">CONSTANT_Class</td>
<td style="text-align:center">7</td>
</tr>
<tr>
<td style="text-align:center">CONSTANT_Fieldref</td>
<td style="text-align:center">9</td>
</tr>
<tr>
<td style="text-align:center">CONSTANT_Methodref</td>
<td style="text-align:center">10</td>
</tr>
<tr>
<td style="text-align:center">CONSTANT_InterfaceMethodref</td>
<td style="text-align:center">11</td>
</tr>
<tr>
<td style="text-align:center">CONSTANT_String</td>
<td style="text-align:center">8</td>
</tr>
<tr>
<td style="text-align:center">CONSTANT_Integer</td>
<td style="text-align:center">3</td>
</tr>
<tr>
<td style="text-align:center">CONSTANT_Float</td>
<td style="text-align:center">4</td>
</tr>
<tr>
<td style="text-align:center">CONSTANT_Long</td>
<td style="text-align:center">5</td>
</tr>
<tr>
<td style="text-align:center">CONSTANT_Double</td>
<td style="text-align:center">6</td>
</tr>
<tr>
<td style="text-align:center">CONSTANT_NameAndType</td>
<td style="text-align:center">12</td>
</tr>
<tr>
<td style="text-align:center">CONSTANT_Utf8</td>
<td style="text-align:center">1</td>
</tr>
<tr>
<td style="text-align:center">CONSTANT_MethodHandle</td>
<td style="text-align:center">15</td>
</tr>
<tr>
<td style="text-align:center">CONSTANT_MethodType</td>
<td style="text-align:center">16</td>
</tr>
<tr>
<td style="text-align:center">CONSTANT_InvokeDynamic</td>
<td style="text-align:center">18</td>
</tr>
</tbody>
</table>
<p><img src="/images/bytecode/constant_pool.png" alt="class常量池"></p>
<p>我们来看两个：</p>
<h3 id="6-1-CONSTANT-Methodref例子"><a href="#6-1-CONSTANT-Methodref例子" class="headerlink" title="6.1 CONSTANT_Methodref例子"></a>6.1 CONSTANT_Methodref例子</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>a <span class="number">00</span> <span class="number">07</span> <span class="number">00</span> <span class="number">14</span></span><br></pre></td></tr></table></figure>
<p>u1:tag =&gt; 0a =&gt; CONSTANT_Methodref(10)</p>
<p>CONSTANT_Methodref结构为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">CONSTANT_Methodref_info &#123;</span><br><span class="line">  u1 tag;</span><br><span class="line">  u2 class_index;</span><br><span class="line">  u2 name_and_type_index;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>那么对应的：</p>
<p>u2:class_index =&gt; 00 07 =&gt; 指向常量表弟7项类型为CONSTANT_Class的常量 =&gt; java/lang/Object</p>
<p>u2:name_and_type_index =&gt; 00 14 =&gt; 指向常量表弟20项类型为CONSTANT_NameAndType的常量 =&gt; “<init>“:()V</init></p>
<h3 id="6-2-CONSTANT-Utf8例子"><a href="#6-2-CONSTANT-Utf8例子" class="headerlink" title="6.2 CONSTANT_Utf8例子"></a>6.2 CONSTANT_Utf8例子</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">01</span> <span class="number">00</span> <span class="number">12</span> <span class="number">4</span>c <span class="number">6</span>a <span class="number">61</span> <span class="number">76</span> <span class="number">61</span> <span class="number">2f</span> <span class="number">6</span>c <span class="number">61</span> <span class="number">6</span>e <span class="number">67</span> <span class="number">2f</span> <span class="number">53</span> <span class="number">74</span> <span class="number">72</span> <span class="number">69</span> <span class="number">6</span>e <span class="number">67</span> <span class="number">3</span>b</span><br></pre></td></tr></table></figure>
<p>u1:tag =&gt; 01 =&gt; CONSTANT_Utf8(1)</p>
<p>CONSTANT_Utf8的结构为</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">CONSTANT_Utf8_info &#123;</span><br><span class="line">    u1 tag;</span><br><span class="line">    u2 length;</span><br><span class="line">    u1 bytes[length];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>u2:length =&gt; 00 12 =&gt; 长度为18 </p>
<p>u2:bytes[] =&gt; 4c 6a 61 76 61 2f 6c 61 6e 67 2f 53 74 72 69 6e 67 3b =&gt; UTF-8缩写编码表示的字符串，128个US-ASCII字符只需一个字节编码（Unicode范围由U+0000至U+007F）=&gt; Ljava/lang/String;</p>
<p>其他更多类型查看<a href="https://docs.oracle.com/javase/specs/jvms/se7/html/jvms-4.html" target="_blank" rel="external">官网</a>。</p>
<h2 id="7-访问标志（u2-access-flags）"><a href="#7-访问标志（u2-access-flags）" class="headerlink" title="7. 访问标志（u2:access_flags）"></a>7. 访问标志（u2:access_flags）</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00</span> <span class="number">21</span></span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th style="text-align:center">标记名</th>
<th style="text-align:center">值</th>
<th style="text-align:center">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">ACC_PUBLIC</td>
<td style="text-align:center">0x0001</td>
<td style="text-align:center">是否为public类型</td>
</tr>
<tr>
<td style="text-align:center">ACC_FINAL</td>
<td style="text-align:center">0x0010</td>
<td style="text-align:center">是否被申明为final，只有类可设置</td>
</tr>
<tr>
<td style="text-align:center">ACC_SUPER</td>
<td style="text-align:center">0x0020</td>
<td style="text-align:center">是否允许使用invokespecial字节码指令的新语义，JDK 1.0.2之后编译出来的类这个标志都必须为真</td>
</tr>
<tr>
<td style="text-align:center">ACC_INTERFACE</td>
<td style="text-align:center">0x0200</td>
<td style="text-align:center">标识接口</td>
</tr>
<tr>
<td style="text-align:center">ACC_ABSTRACT</td>
<td style="text-align:center">0x0400</td>
<td style="text-align:center">是否为abstract，对于接口和抽象类来说，此标志为真，其他类值为假的</td>
</tr>
<tr>
<td style="text-align:center">ACC_SYNTHETIC</td>
<td style="text-align:center">0x1000</td>
<td style="text-align:center">标识这个类并非由用户代码产生的</td>
</tr>
<tr>
<td style="text-align:center">ACC_ANNOTATION</td>
<td style="text-align:center">0x2000</td>
<td style="text-align:center">标识这是一个注解</td>
</tr>
<tr>
<td style="text-align:center">ACC_ENUM</td>
<td style="text-align:center">0x4000</td>
<td style="text-align:center">标识这是一个枚举</td>
</tr>
</tbody>
</table>
<p>我们的例子是一个最简单的类，并且编译器在1.0.2之后所以 ACC_PUBLIC ACC_SUPER 为真 即<br>0x0001 | 0x0020 所以我们的结果是0021</p>
<h2 id="8-类索引（u2-this-class）"><a href="#8-类索引（u2-this-class）" class="headerlink" title="8. 类索引（u2: this_class）"></a>8. 类索引（u2: this_class）</h2><p>用来确定这个类的全限定名。</p>
<p>本例中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00</span> <span class="number">06</span></span><br></pre></td></tr></table></figure>
<p>这个索引指向常量池index为6类型为Class的常量，即：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#6 = Class              #27            // com/qinglinyi/demo/ByteCodeSample</span><br></pre></td></tr></table></figure>
<h2 id="9-父类索引（u2-super-class）"><a href="#9-父类索引（u2-super-class）" class="headerlink" title="9. 父类索引（u2: super_class）"></a>9. 父类索引（u2: super_class）</h2><p>用来确定这个类父类的全限定名。</p>
<p>本例中：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00</span> <span class="number">07</span></span><br></pre></td></tr></table></figure></p>
<p>同类索引指向：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#7 = Class              #28            // java/lang/Object</span><br></pre></td></tr></table></figure>
<h2 id="10-接口计数器（u2-interfaces-count）"><a href="#10-接口计数器（u2-interfaces-count）" class="headerlink" title="10. 接口计数器（u2: interfaces_count）"></a>10. 接口计数器（u2: interfaces_count）</h2><p>用来标记接口（索引）的数量</p>
<p>本例中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00</span> <span class="number">00</span></span><br></pre></td></tr></table></figure>
<p>我们的例子没有接口，所以数量为0</p>
<h2 id="11-接口索引集合（u2-interfaces）"><a href="#11-接口索引集合（u2-interfaces）" class="headerlink" title="11. 接口索引集合（u2: interfaces）"></a>11. 接口索引集合（u2: interfaces）</h2><p>用来描述该类实现哪些接口</p>
<p>interfaces_count个u2，每个u2指向常量池，标记一个接口。</p>
<p>本例中没有接口。</p>
<h2 id="12-字段计数器（u2-fields-count）"><a href="#12-字段计数器（u2-fields-count）" class="headerlink" title="12. 字段计数器（u2: fields_count）"></a>12. 字段计数器（u2: fields_count）</h2><p>用来标记字段数量</p>
<p>本例中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00</span> <span class="number">01</span></span><br></pre></td></tr></table></figure>
<p>我们只有一个字段</p>
<h2 id="13-字段表集合（field-info-fields-fields-count-）"><a href="#13-字段表集合（field-info-fields-fields-count-）" class="headerlink" title="13. 字段表集合（field_info: fields[fields_count]）"></a>13. 字段表集合（field_info: fields[fields_count]）</h2><p>有fields_count个字段表field_info，用来表示字段。</p>
<p>本例中：</p>
<p><img src="/images/bytecode/field_info.png" width="800" alt="字段表集合"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00</span> <span class="number">02</span> <span class="number">00</span> <span class="number">08</span> <span class="number">00</span> <span class="number">09</span> <span class="number">00</span> <span class="number">00</span></span><br></pre></td></tr></table></figure>
<p>因为只有一个字段，所以就一个field_info</p>
<p>字段表的结构是这样的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">field_info &#123;</span><br><span class="line">    u2             access_flags;</span><br><span class="line">    u2             name_index;</span><br><span class="line">    u2             descriptor_index;</span><br><span class="line">    u2             attributes_count;</span><br><span class="line">    attribute_info attributes[attributes_count];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>也就是这样：</p>
<p><img src="/images/bytecode/field_info2.png" width="800" alt="字段表集合"></p>
<h3 id="13-1-u2-access-flag"><a href="#13-1-u2-access-flag" class="headerlink" title="13.1 u2: access_flag"></a>13.1 u2: access_flag</h3><p>字段的访问权限类型有这些：</p>
<table>
<thead>
<tr>
<th>类型</th>
<th style="text-align:center">值</th>
</tr>
</thead>
<tbody>
<tr>
<td>ACC_PUBLIC</td>
<td style="text-align:center">0x0001  </td>
</tr>
<tr>
<td>ACC_PRIVATE</td>
<td style="text-align:center">0x0002</td>
</tr>
<tr>
<td>ACC_PROTECTED</td>
<td style="text-align:center">0x0004</td>
</tr>
<tr>
<td>ACC_STATIC</td>
<td style="text-align:center">0x0008</td>
</tr>
<tr>
<td>ACC_FINAL</td>
<td style="text-align:center">0x0010</td>
</tr>
<tr>
<td>ACC_VOLATILE</td>
<td style="text-align:center">0x0040</td>
</tr>
<tr>
<td>ACC_TRANSIENT</td>
<td style="text-align:center">0x0080</td>
</tr>
<tr>
<td>ACC_SYNTHETIC</td>
<td style="text-align:center">0x1000</td>
</tr>
<tr>
<td>ACC_ENUM</td>
<td style="text-align:center">0x4000</td>
</tr>
</tbody>
</table>
<p>本例中：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">00 02</span><br><span class="line">```	</span><br><span class="line">   </span><br><span class="line">所以我们只有一个ACC_PUBLIC</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">### 13.2 u2: name_index</span><br><span class="line"></span><br><span class="line">字段名索引，可以获取字段名</span><br><span class="line"></span><br><span class="line">本例中：</span><br><span class="line"></span><br><span class="line">```java</span><br><span class="line">00 08</span><br></pre></td></tr></table></figure>
<p>对应的常量池：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#8 = Utf8               msg</span><br></pre></td></tr></table></figure>
<p>说明我们的字段名字是msg</p>
<h3 id="13-3-u2-descriptor-index"><a href="#13-3-u2-descriptor-index" class="headerlink" title="13.3 u2: descriptor_index"></a>13.3 u2: descriptor_index</h3><p>描述符索引</p>
<p>本例中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00</span> <span class="number">09</span></span><br></pre></td></tr></table></figure>
<p>对应的常量池：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#9 = Utf8               Ljava/lang/String;</span><br></pre></td></tr></table></figure>
<p>说明我们这个字段是String类型</p>
<h3 id="13-4-u2-attributes-count"><a href="#13-4-u2-attributes-count" class="headerlink" title="13.4 u2: attributes_count"></a>13.4 u2: attributes_count</h3><p>属性数量</p>
<p>本例中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00</span> <span class="number">00</span></span><br></pre></td></tr></table></figure>
<p>数量为0，无属性。</p>
<h3 id="13-5-attribute-info-attributes-attributes-count"><a href="#13-5-attribute-info-attributes-attributes-count" class="headerlink" title="13.5 attribute_info attributes[attributes_count]"></a>13.5 attribute_info attributes[attributes_count]</h3><p>attributes_count个attribute_info，对应着attributes_count个属性，本例中数量为0。</p>
<h2 id="14-方法计数器（u2-methods-count）"><a href="#14-方法计数器（u2-methods-count）" class="headerlink" title="14. 方法计数器（u2: methods_count）"></a>14. 方法计数器（u2: methods_count）</h2><p>用来标记方法数量</p>
<p>本例中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00</span> <span class="number">02</span></span><br></pre></td></tr></table></figure>
<p>我们只有2个方法</p>
<h2 id="15-方法表集合（method-info-methods-methods-count-）"><a href="#15-方法表集合（method-info-methods-methods-count-）" class="headerlink" title="15. 方法表集合（method_info: methods[methods_count]）"></a>15. 方法表集合（method_info: methods[methods_count]）</h2><p>有methods_count个字段表method_info，用来表示方法。</p>
<p>结构如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">method_info &#123;</span><br><span class="line">    u2             access_flags;</span><br><span class="line">    u2             name_index;</span><br><span class="line">    u2             descriptor_index;</span><br><span class="line">    u2             attributes_count;</span><br><span class="line">    attribute_info attributes[attributes_count];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>本例中：</p>
<p>第一个方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">  <span class="number">00</span> <span class="number">0100</span> <span class="number">0</span>a00 <span class="number">0b00</span> <span class="number">0100</span> <span class="number">0</span>c00 <span class="number">0000</span> <span class="number">3900</span></span><br><span class="line"><span class="number">0200</span> <span class="number">0100</span> <span class="number">0000</span> <span class="number">0</span>b2a b700 <span class="number">012</span>a <span class="number">1202</span> b500</span><br><span class="line"><span class="number">03</span>b1 <span class="number">0000</span> <span class="number">0002</span> <span class="number">000</span>d <span class="number">0000</span> <span class="number">000</span>a <span class="number">0002</span> <span class="number">0000</span></span><br><span class="line"><span class="number">0004</span> <span class="number">0004</span> <span class="number">0006</span> <span class="number">000</span>e <span class="number">0000</span> <span class="number">000</span>c <span class="number">0001</span> <span class="number">0000</span></span><br><span class="line"><span class="number">000</span>b <span class="number">000f</span> <span class="number">0010</span> <span class="number">0000</span></span><br></pre></td></tr></table></figure>
<p>第二个方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">                    <span class="number">0001</span> <span class="number">0011</span> <span class="number">000</span>b <span class="number">0001</span></span><br><span class="line"><span class="number">000</span>c <span class="number">0000</span> <span class="number">0039</span> <span class="number">0002</span> <span class="number">0001</span> <span class="number">0000</span> <span class="number">000</span>b b200</span><br><span class="line"><span class="number">042</span>a b400 <span class="number">03</span>b6 <span class="number">0005</span> b100 <span class="number">0000</span> <span class="number">0200</span> <span class="number">0</span>d00</span><br><span class="line"><span class="number">0000</span> <span class="number">0</span>a00 <span class="number">0200</span> <span class="number">0000</span> <span class="number">0900</span> <span class="number">0</span>a00 <span class="number">0</span>a00 <span class="number">0e00</span></span><br><span class="line"><span class="number">0000</span> <span class="number">0</span>c00 <span class="number">0100</span> <span class="number">0000</span> <span class="number">0b00</span> <span class="number">0f</span>00 <span class="number">1000</span> <span class="number">00</span></span><br></pre></td></tr></table></figure>
<p><img src="/images/bytecode/methodinfo.png" alt="方法表"></p>
<p>先看看第一个方法：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">public com.qinglinyi.demo.ByteCodeSample();</span><br><span class="line">  descriptor: ()V</span><br><span class="line">  flags: ACC_PUBLIC</span><br><span class="line">  Code:</span><br><span class="line">    stack=2, locals=1, args_size=1</span><br><span class="line">       0: aload_0</span><br><span class="line">       1: invokespecial #1                  // Method java/lang/Object."&lt;init&gt;":()V</span><br><span class="line">       4: aload_0</span><br><span class="line">       5: ldc           #2                  // String hello world</span><br><span class="line">       7: putfield      #3                  // Field msg:Ljava/lang/String;</span><br><span class="line">      10: return</span><br><span class="line">    LineNumberTable:</span><br><span class="line">      line 4: 0</span><br><span class="line">      line 6: 4</span><br><span class="line">    LocalVariableTable:</span><br><span class="line">      Start  Length  Slot  Name   Signature</span><br><span class="line">          0      11     0  this   Lcom/qinglinyi/demo/ByteCodeSample;</span><br></pre></td></tr></table></figure>
<h3 id="15-1-u2-access-flag"><a href="#15-1-u2-access-flag" class="headerlink" title="15.1 u2: access_flag"></a>15.1 u2: access_flag</h3><p>和字段表访问标志类似</p>
<p>方法访问标志如下表：</p>
<table>
<thead>
<tr>
<th style="text-align:center">标记名</th>
<th style="text-align:center">值</th>
<th style="text-align:center">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">ACC_PUBLIC</td>
<td style="text-align:center">0x0001</td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">ACC_PRIVATE</td>
<td style="text-align:center">0x0002</td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">ACC_PROTECTED</td>
<td style="text-align:center">0x0004</td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">ACC_STATIC</td>
<td style="text-align:center">0x0008</td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">ACC_FINAL</td>
<td style="text-align:center">0x0010</td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">ACC_SYNCHRONIZED</td>
<td style="text-align:center">0x0020</td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">ACC_BRIDGE</td>
<td style="text-align:center">0x0040</td>
<td style="text-align:center">是否由编译器产生的桥接方法</td>
</tr>
<tr>
<td style="text-align:center">ACC_VARARGS</td>
<td style="text-align:center">0x0080</td>
<td style="text-align:center">是否接受不定参数</td>
</tr>
<tr>
<td style="text-align:center">ACC_NATIVE</td>
<td style="text-align:center">0x0100</td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">ACC_ABSTRACT</td>
<td style="text-align:center">0x0400</td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">ACC_STRICT</td>
<td style="text-align:center">0x0800</td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">ACC_SYNTHETIC</td>
<td style="text-align:center">0x1000</td>
<td style="text-align:center">方法是否由编译器自动产生</td>
</tr>
</tbody>
</table>
<p>本例中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00</span> <span class="number">01</span></span><br></pre></td></tr></table></figure>
<p>该方法为public方法。</p>
<h3 id="15-2-u2-name-index"><a href="#15-2-u2-name-index" class="headerlink" title="15.2 u2: name_index"></a>15.2 u2: name_index</h3><p>方法名索引，本例中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00</span> <span class="number">0</span>b</span><br></pre></td></tr></table></figure>
<p>对应的方法名：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#10 = Utf8               &lt;init&gt;</span><br></pre></td></tr></table></figure>
<h3 id="15-3-u2-descriptor-index"><a href="#15-3-u2-descriptor-index" class="headerlink" title="15.3 u2: descriptor_index"></a>15.3 u2: descriptor_index</h3><p>描述符索引，本例中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00</span> <span class="number">0</span>a</span><br></pre></td></tr></table></figure>
<p>对应的方法名：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#11 = Utf8               ()V</span><br></pre></td></tr></table></figure>
<h3 id="15-4-u2-attributes-count"><a href="#15-4-u2-attributes-count" class="headerlink" title="15.4 u2: attributes_count"></a>15.4 u2: attributes_count</h3><p>属性计数器，本例中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00</span> <span class="number">01</span></span><br></pre></td></tr></table></figure>
<p>1个属性</p>
<h3 id="15-5-attribute-info-attributes-attributes-count"><a href="#15-5-attribute-info-attributes-attributes-count" class="headerlink" title="15.5 attribute_info attributes[attributes_count]"></a>15.5 attribute_info attributes[attributes_count]</h3><p>属性表集合</p>
<p>属性结构如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">attribute_info &#123;</span><br><span class="line">    u2 attribute_name_index;</span><br><span class="line">    u4 attribute_length;</span><br><span class="line">    u1 info[attribute_length];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>本例中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">                      <span class="number">00</span> <span class="number">0</span>c00 <span class="number">0000</span> <span class="number">3900</span></span><br><span class="line"><span class="number">0200</span> <span class="number">0100</span> <span class="number">0000</span> <span class="number">0</span>b2a b700 <span class="number">012</span>a <span class="number">1202</span> b500</span><br><span class="line"><span class="number">03</span>b1 <span class="number">0000</span> <span class="number">0002</span> <span class="number">000</span>d <span class="number">0000</span> <span class="number">000</span>a <span class="number">0002</span> <span class="number">0000</span></span><br><span class="line"><span class="number">0004</span> <span class="number">0004</span> <span class="number">0006</span> <span class="number">000</span>e <span class="number">0000</span> <span class="number">000</span>c <span class="number">0001</span> <span class="number">0000</span></span><br><span class="line"><span class="number">000</span>b <span class="number">000f</span> <span class="number">0010</span> <span class="number">0000</span></span><br></pre></td></tr></table></figure>
<h4 id="15-5-1-u2-attribute-name-index"><a href="#15-5-1-u2-attribute-name-index" class="headerlink" title="15.5.1 u2: attribute_name_index"></a>15.5.1 u2: attribute_name_index</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00</span> <span class="number">0</span>c</span><br></pre></td></tr></table></figure>
<p>指向</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#12 = Utf8               Code</span><br></pre></td></tr></table></figure>
<p>code类型：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Code_attribute &#123;</span><br><span class="line">    u2 attribute_name_index;</span><br><span class="line">    u4 attribute_length;</span><br><span class="line">    u2 max_stack;</span><br><span class="line">    u2 max_locals;</span><br><span class="line">    u4 code_length;</span><br><span class="line">    u1 code[code_length];</span><br><span class="line">    u2 exception_table_length;</span><br><span class="line">    &#123;   u2 start_pc;</span><br><span class="line">        u2 end_pc;</span><br><span class="line">        u2 handler_pc;</span><br><span class="line">        u2 catch_type;</span><br><span class="line">    &#125; exception_table[exception_table_length];</span><br><span class="line">    u2 attributes_count;</span><br><span class="line">    attribute_info attributes[attributes_count];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="15-5-2-u4-attribute-length"><a href="#15-5-2-u4-attribute-length" class="headerlink" title="15.5.2 u4: attribute_length"></a>15.5.2 u4: attribute_length</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">39</span></span><br></pre></td></tr></table></figure>
<p>属性数量为57</p>
<h4 id="15-5-3-other"><a href="#15-5-3-other" class="headerlink" title="15.5.3 other"></a>15.5.3 other</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">                                     <span class="number">00</span></span><br><span class="line"><span class="number">0200</span> <span class="number">0100</span> <span class="number">0000</span> <span class="number">0</span>b2a b700 <span class="number">012</span>a <span class="number">1202</span> b500</span><br><span class="line"><span class="number">03</span>b1 <span class="number">0000</span> <span class="number">0002</span> <span class="number">000</span>d <span class="number">0000</span> <span class="number">000</span>a <span class="number">0002</span> <span class="number">0000</span></span><br><span class="line"><span class="number">0004</span> <span class="number">0004</span> <span class="number">0006</span> <span class="number">000</span>e <span class="number">0000</span> <span class="number">000</span>c <span class="number">0001</span> <span class="number">0000</span></span><br><span class="line"><span class="number">000</span>b <span class="number">000f</span> <span class="number">0010</span> <span class="number">0000</span></span><br></pre></td></tr></table></figure>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Code:</span><br><span class="line">      stack=2, locals=1, args_size=1</span><br><span class="line">         0: aload_0</span><br><span class="line">         1: invokespecial #1                  // Method java/lang/Object."&lt;init&gt;":()V</span><br><span class="line">         4: aload_0</span><br><span class="line">         5: ldc           #2                  // String hello world</span><br><span class="line">         7: putfield      #3                  // Field msg:Ljava/lang/String;</span><br><span class="line">        10: return</span><br><span class="line">      LineNumberTable:</span><br><span class="line">        line 4: 0</span><br><span class="line">        line 6: 4</span><br><span class="line">      LocalVariableTable:</span><br><span class="line">        Start  Length  Slot  Name   Signature</span><br><span class="line">            0      11     0  this   Lcom/qinglinyi/demo/ByteCodeSample;</span><br></pre></td></tr></table></figure>
<h2 id="16-属性计数器（u2-attributes-count）"><a href="#16-属性计数器（u2-attributes-count）" class="headerlink" title="16. 属性计数器（u2: attributes_count）"></a>16. 属性计数器（u2: attributes_count）</h2><p>类属性数量，本例中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00</span> <span class="number">01</span></span><br></pre></td></tr></table></figure>
<p>一个属性</p>
<h2 id="17-属性表集合（attribute-info-attributes-attributes-count-）"><a href="#17-属性表集合（attribute-info-attributes-attributes-count-）" class="headerlink" title="17. 属性表集合（attribute_info: attributes[attributes_count]）"></a>17. 属性表集合（attribute_info: attributes[attributes_count]）</h2><p>类属性集合，本例只有一个：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00</span> <span class="number">12</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">02</span> <span class="number">00</span> <span class="number">13</span></span><br></pre></td></tr></table></figure>
<p>0012对应</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#18 = Utf8               SourceFile</span><br></pre></td></tr></table></figure>
<p>这是一个SourceFile类型的属性，结构如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">SourceFile_attribute &#123;</span><br><span class="line">    u2 attribute_name_index;</span><br><span class="line">    u4 attribute_length;</span><br><span class="line">    u2 sourcefile_index;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>attribute_length:00 00 00 02为2，属性长度为2（SourceFile的长度就是2）。<br>sourcefile_index:00 13为13（十进制19）对应：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#19 = Utf8               ByteCodeSample.java</span><br></pre></td></tr></table></figure>
<p><em>ps: 属性还有其他类型，暂略。。</em></p>
<p><em>ps: 更多详细内容，请看参考</em></p>
<h2 id="18-参考"><a href="#18-参考" class="headerlink" title="18. 参考"></a>18. 参考</h2><p>1.<a href="http://blog.csdn.net/dc_726/article/details/7944154" target="_blank" rel="external">学会阅读Java字节码</a><br>2.《深入理解Java虚拟机：JVM高级特性与最佳实践 第2版》<br>3.<a href="https://docs.oracle.com/javase/specs/jvms/se7/html/jvms-4.html#jvms-4.7.10" target="_blank" rel="external">java文档</a></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Java/">Java</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/Java/">Java</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>











  
    <article id="post-Window" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/posts/Window/" class="article-date">
  	<time datetime="2016-10-31T07:35:46.000Z" itemprop="datePublished">2016-10-31</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/posts/Window/">Window</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>本文简单介绍Window的创建过程。基于源码6.0，主要参考<a href="http://blog.csdn.net/luoshengyang/article/details/8223770" target="_blank" rel="external">这里</a>。</p>
<h2 id="1-创建过程"><a href="#1-创建过程" class="headerlink" title="1.创建过程"></a>1.创建过程</h2><p><img src="/images/window/Window.png" width="816" height="612" alt="Window"></p>
<h3 id="Step1-Activity-attach"><a href="#Step1-Activity-attach" class="headerlink" title="Step1:  Activity.attach"></a>Step1:  Activity.attach</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">attach</span><span class="params">(Context context, ActivityThread aThread,</span><br><span class="line">       Instrumentation instr, IBinder token, <span class="keyword">int</span> ident,</span><br><span class="line">       Application application, Intent intent, ActivityInfo info,</span><br><span class="line">       CharSequence title, Activity parent, String id,</span><br><span class="line">       NonConfigurationInstances lastNonConfigurationInstances,</span><br><span class="line">       Configuration config, String referrer, IVoiceInteractor voiceInteractor)</span> </span>&#123;</span><br><span class="line">   ...</span><br><span class="line">   mWindow = <span class="keyword">new</span> PhoneWindow(<span class="keyword">this</span>);</span><br><span class="line">   mWindow.setCallback(<span class="keyword">this</span>);</span><br><span class="line">   mWindow.setOnWindowDismissedCallback(<span class="keyword">this</span>);</span><br><span class="line">   mWindow.getLayoutInflater().setPrivateFactory(<span class="keyword">this</span>);</span><br><span class="line">   <span class="keyword">if</span> (info.softInputMode != WindowManager.LayoutParams.SOFT_INPUT_STATE_UNSPECIFIED) &#123;</span><br><span class="line">       mWindow.setSoftInputMode(info.softInputMode);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">if</span> (info.uiOptions != <span class="number">0</span>) &#123;</span><br><span class="line">       mWindow.setUiOptions(info.uiOptions);</span><br><span class="line">   &#125;</span><br><span class="line">  ...</span><br><span class="line">   mWindow.setWindowManager(</span><br><span class="line">           (WindowManager)context.getSystemService(Context.WINDOW_SERVICE),</span><br><span class="line">           mToken, mComponent.flattenToString(),</span><br><span class="line">           (info.flags &amp; ActivityInfo.FLAG_HARDWARE_ACCELERATED) != <span class="number">0</span>);</span><br><span class="line">   <span class="keyword">if</span> (mParent != <span class="keyword">null</span>) &#123;</span><br><span class="line">       mWindow.setContainer(mParent.getWindow());</span><br><span class="line">   &#125;</span><br><span class="line">   mWindowManager = mWindow.getWindowManager();</span><br><span class="line">   ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>这个函数定义在文件frameworks/base/core/Java/android/app/Activity.java中。</p>
</blockquote>
<p>在attach方法中，创建PhoneWindow对象并且保存在Activity类的成员变量mWindow中。然后方法setCallback、setOnWindowDismissedCallback、setSoftInputMode和setWindowManager来设置窗口回调接口、窗口消失回调接口、软键盘输入区域的显示模式和窗口管理器。</p>
<h3 id="Step2-PhoneWindow-new"><a href="#Step2-PhoneWindow-new" class="headerlink" title="Step2: PhoneWindow.new"></a>Step2: PhoneWindow.new</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PhoneWindow</span> <span class="keyword">extends</span> <span class="title">Window</span> <span class="keyword">implements</span> <span class="title">MenuBuilder</span>.<span class="title">Callback</span> </span>&#123;</span><br><span class="line">	...</span><br><span class="line">	<span class="keyword">private</span> LayoutInflater mLayoutInflater;</span><br><span class="line">	...</span><br><span class="line">	<span class="keyword">private</span> DecorView mDecor;</span><br><span class="line">	<span class="keyword">private</span> ViewGroup mContentParent;</span><br><span class="line">	...</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">PhoneWindow</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>(context);</span><br><span class="line">		mLayoutInflater = LayoutInflater.from(context);</span><br><span class="line">	&#125;</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>这个函数定义在文件frameworks/base/core/java/com/android/internal/policy/PhoneWindow.java中。</p>
<p>调用LayoutInflater的静态成员函数from创建一个LayoutInflater实例，并且保存在成员变量mLayoutInflater中。这样，PhoneWindow类以后就可以通过成员变量mLayoutInflater来创建应用程序窗口的视图，这个视图使用类型为DecorView的成员变量mDecor来描述。PhoneWindow类还有另外一个类型为ViewGroup的成员变量mContentParent，用来描述一个视图容器，这个容器存放的就是成员变量mDecor所描述的视图的内容，不过这个容器也有可能指向的是mDecor本身。</p>
</blockquote>
<p>Window的构造很简单，只是初始化一个Context。如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Window</span> </span>&#123;</span><br><span class="line">	...</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> Context mContext;</span><br><span class="line">	...</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> mFeatures;</span><br><span class="line">	...</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Window</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">		mContext = context;</span><br><span class="line">		mFeatures = mLocalFeatures = getDefaultFeatures(context);</span><br><span class="line">	&#125;</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>这个函数定义在frameworks/base/core/java/android/view/Window.java中。</p>
</blockquote>
<p>这个Context来自Activity，这样Window可以访问Activity的相关资源。使用getDefaultFeatures<br>方法设置默认的Features，这些Features将在requestFeature()中使用到，用来设置Window的一些现实特征，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** Flag for the "options panel" feature.  This is enabled by default. */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> FEATURE_OPTIONS_PANEL = <span class="number">0</span>;</span><br><span class="line"><span class="comment">/** Flag for the "no title" feature, turning off the title at the top</span><br><span class="line">*  of the screen. */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> FEATURE_NO_TITLE = <span class="number">1</span>;</span><br><span class="line"><span class="comment">/** Flag for the progress indicator feature */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> FEATURE_PROGRESS = <span class="number">2</span>;</span><br><span class="line"><span class="comment">/** Flag for having an icon on the left side of the title bar */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> FEATURE_LEFT_ICON = <span class="number">3</span>;</span><br><span class="line"><span class="comment">/** Flag for having an icon on the right side of the title bar */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> FEATURE_RIGHT_ICON = <span class="number">4</span>;</span><br><span class="line"><span class="comment">/** Flag for indeterminate progress */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> FEATURE_INDETERMINATE_PROGRESS = <span class="number">5</span>;</span><br><span class="line"><span class="comment">/** Flag for the context menu.  This is enabled by default. */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> FEATURE_CONTEXT_MENU = <span class="number">6</span>;</span><br><span class="line"><span class="comment">/** Flag for custom title. You cannot combine this feature with other title features. */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> FEATURE_CUSTOM_TITLE = <span class="number">7</span>;</span><br><span class="line"><span class="comment">/**</span><br><span class="line">* Flag for enabling the Action Bar.</span><br><span class="line">* This is enabled by default for some devices. The Action Bar</span><br><span class="line">* replaces the title bar and provides an alternate location</span><br><span class="line">* for an on-screen menu button on some devices.</span><br><span class="line">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> FEATURE_ACTION_BAR = <span class="number">8</span>;</span><br><span class="line"><span class="comment">/**</span><br><span class="line">* Flag for requesting an Action Bar that overlays window content.</span><br><span class="line">* Normally an Action Bar will sit in the space above window content, but if this</span><br><span class="line">* feature is requested along with &#123;<span class="doctag">@link</span> #FEATURE_ACTION_BAR&#125; it will be layered over</span><br><span class="line">* the window content itself. This is useful if you would like your app to have more control</span><br><span class="line">* over how the Action Bar is displayed, such as letting application content scroll beneath</span><br><span class="line">* an Action Bar with a transparent background or otherwise displaying a transparent/translucent</span><br><span class="line">* Action Bar over application content.</span><br><span class="line">*</span><br><span class="line">* &lt;p&gt;This mode is especially useful with &#123;<span class="doctag">@link</span> View#SYSTEM_UI_FLAG_FULLSCREEN</span><br><span class="line">* View.SYSTEM_UI_FLAG_FULLSCREEN&#125;, which allows you to seamlessly hide the</span><br><span class="line">* action bar in conjunction with other screen decorations.</span><br><span class="line">*</span><br><span class="line">* &lt;p&gt;As of &#123;<span class="doctag">@link</span> android.os.Build.VERSION_CODES#JELLY_BEAN&#125;, when an</span><br><span class="line">* ActionBar is in this mode it will adjust the insets provided to</span><br><span class="line">* &#123;<span class="doctag">@link</span> View#fitSystemWindows(android.graphics.Rect) View.fitSystemWindows(Rect)&#125;</span><br><span class="line">* to include the content covered by the action bar, so you can do layout within</span><br><span class="line">* that space.</span><br><span class="line">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> FEATURE_ACTION_BAR_OVERLAY = <span class="number">9</span>;</span><br><span class="line"><span class="comment">/**</span><br><span class="line">* Flag for specifying the behavior of action modes when an Action Bar is not present.</span><br><span class="line">* If overlay is enabled, the action mode UI will be allowed to cover existing window content.</span><br><span class="line">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> FEATURE_ACTION_MODE_OVERLAY = <span class="number">10</span>;</span><br><span class="line"><span class="comment">/**</span><br><span class="line">* Flag for requesting a decoration-free window that is dismissed by swiping from the left.</span><br><span class="line">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> FEATURE_SWIPE_TO_DISMISS = <span class="number">11</span>;</span><br><span class="line"><span class="comment">/**</span><br><span class="line">* Flag for requesting that window content changes should be animated using a</span><br><span class="line">* TransitionManager.</span><br><span class="line">*</span><br><span class="line">* &lt;p&gt;The TransitionManager is set using</span><br><span class="line">* &#123;<span class="doctag">@link</span> #setTransitionManager(android.transition.TransitionManager)&#125;. If none is set,</span><br><span class="line">* a default TransitionManager will be used.&lt;/p&gt;</span><br><span class="line">*</span><br><span class="line">* <span class="doctag">@see</span> #setContentView</span><br><span class="line">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> FEATURE_CONTENT_TRANSITIONS = <span class="number">12</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line">* Enables Activities to run Activity Transitions either through sending or receiving</span><br><span class="line">* ActivityOptions bundle created with</span><br><span class="line">* &#123;<span class="doctag">@link</span> android.app.ActivityOptions#makeSceneTransitionAnimation(android.app.Activity,</span><br><span class="line">* android.util.Pair[])&#125; or &#123;<span class="doctag">@link</span> android.app.ActivityOptions#makeSceneTransitionAnimation(</span><br><span class="line">* android.app.Activity, View, String)&#125;.</span><br><span class="line">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> FEATURE_ACTIVITY_TRANSITIONS = <span class="number">13</span>;</span><br></pre></td></tr></table></figure>
<h3 id="Step3-Window-setCallback"><a href="#Step3-Window-setCallback" class="headerlink" title="Step3: Window.setCallback"></a>Step3: Window.setCallback</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Window</span> </span>&#123;</span><br><span class="line">	...</span><br><span class="line">	<span class="keyword">private</span> Callback mCallback;</span><br><span class="line">	...</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCallback</span><span class="params">(Callback callback)</span> </span>&#123;</span><br><span class="line">		mCallback = callback;</span><br><span class="line">	&#125;</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>这个函数定义在文件frameworks/base/core/java/android/view/Window.java中。</p>
</blockquote>
<p>设置Callback，这个方法在PhoneWindow的父类Window中，用来拦截键盘时间和其他触摸操作等。这个Callback在Activity中实现。</p>
<h3 id="Step4-Window-setOnWindowDismissedCallback"><a href="#Step4-Window-setOnWindowDismissedCallback" class="headerlink" title="Step4: Window.setOnWindowDismissedCallback"></a>Step4: Window.setOnWindowDismissedCallback</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Window</span> </span>&#123;</span><br><span class="line">	...</span><br><span class="line">	<span class="keyword">private</span> OnWindowDismissedCallback mOnWindowDismissedCallback;</span><br><span class="line">	...</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">setOnWindowDismissedCallback</span><span class="params">(OnWindowDismissedCallback dcb)</span> </span>&#123;</span><br><span class="line">		mOnWindowDismissedCallback = dcb;</span><br><span class="line">	&#125;</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>这个函数定义在文件frameworks/base/core/java/android/view/Window.java中。</p>
</blockquote>
<p>这个OnWindowDismissedCallback会在Window gone的时候调用，这个回调也是在Activity中实现。</p>
<h3 id="Step5-Window-setSoftInputMode"><a href="#Step5-Window-setSoftInputMode" class="headerlink" title="Step5: Window.setSoftInputMode"></a>Step5: Window.setSoftInputMode</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Window</span> </span>&#123;</span><br><span class="line">	...</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">boolean</span> mHasSoftInputMode = <span class="keyword">false</span>;</span><br><span class="line">	...</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSoftInputMode</span><span class="params">(<span class="keyword">int</span> mode)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">final</span> WindowManager.LayoutParams attrs = getAttributes();</span><br><span class="line">		<span class="keyword">if</span> (mode != WindowManager.LayoutParams.SOFT_INPUT_STATE_UNSPECIFIED) &#123;</span><br><span class="line">		  attrs.softInputMode = mode;</span><br><span class="line">		  mHasSoftInputMode = <span class="keyword">true</span>;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		  mHasSoftInputMode = <span class="keyword">false</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		dispatchWindowAttributesChanged(attrs);</span><br><span class="line">	&#125;</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>这个函数定义在文件frameworks/base/core/java/android/view/Window.java中。</p>
</blockquote>
<p>setSoftInputMode用来设置应用程序窗口的软键盘输入区域的显示模式。取值如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="comment">/**</span><br><span class="line">* Visibility state for &#123;<span class="doctag">@link</span> #softInputMode&#125;: no state has been specified.</span><br><span class="line">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SOFT_INPUT_STATE_UNSPECIFIED = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line">* Visibility state for &#123;<span class="doctag">@link</span> #softInputMode&#125;: please don't change the state of</span><br><span class="line">* the soft input area.</span><br><span class="line">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SOFT_INPUT_STATE_UNCHANGED = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line">* Visibility state for &#123;<span class="doctag">@link</span> #softInputMode&#125;: please hide any soft input</span><br><span class="line">* area when normally appropriate (when the user is navigating</span><br><span class="line">* forward to your window).</span><br><span class="line">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SOFT_INPUT_STATE_HIDDEN = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line">* Visibility state for &#123;<span class="doctag">@link</span> #softInputMode&#125;: please always hide any</span><br><span class="line">* soft input area when this window receives focus.</span><br><span class="line">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SOFT_INPUT_STATE_ALWAYS_HIDDEN = <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line">* Visibility state for &#123;<span class="doctag">@link</span> #softInputMode&#125;: please show the soft</span><br><span class="line">* input area when normally appropriate (when the user is navigating</span><br><span class="line">* forward to your window).</span><br><span class="line">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SOFT_INPUT_STATE_VISIBLE = <span class="number">4</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line">* Visibility state for &#123;<span class="doctag">@link</span> #softInputMode&#125;: please always make the</span><br><span class="line">* soft input area visible when this window receives input focus.</span><br><span class="line">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SOFT_INPUT_STATE_ALWAYS_VISIBLE = <span class="number">5</span>;</span><br><span class="line">...</span><br><span class="line"><span class="comment">/** Adjustment option for &#123;<span class="doctag">@link</span> #softInputMode&#125;: nothing specified.</span><br><span class="line">* The system will try to pick one or</span><br><span class="line">* the other depending on the contents of the window.</span><br><span class="line">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SOFT_INPUT_ADJUST_UNSPECIFIED = <span class="number">0x00</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** Adjustment option for &#123;<span class="doctag">@link</span> #softInputMode&#125;: set to allow the</span><br><span class="line">* window to be resized when an input</span><br><span class="line">* method is shown, so that its contents are not covered by the input</span><br><span class="line">* method.  This can &lt;em&gt;not&lt;/em&gt; be combined with</span><br><span class="line">* &#123;<span class="doctag">@link</span> #SOFT_INPUT_ADJUST_PAN&#125;; if</span><br><span class="line">* neither of these are set, then the system will try to pick one or</span><br><span class="line">* the other depending on the contents of the window. If the window's</span><br><span class="line">* layout parameter flags include &#123;<span class="doctag">@link</span> #FLAG_FULLSCREEN&#125;, this</span><br><span class="line">* value for &#123;<span class="doctag">@link</span> #softInputMode&#125; will be ignored; the window will</span><br><span class="line">* not resize, but will stay fullscreen.</span><br><span class="line">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SOFT_INPUT_ADJUST_RESIZE = <span class="number">0x10</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** Adjustment option for &#123;<span class="doctag">@link</span> #softInputMode&#125;: set to have a window</span><br><span class="line">* pan when an input method is</span><br><span class="line">* shown, so it doesn't need to deal with resizing but just panned</span><br><span class="line">* by the framework to ensure the current input focus is visible.  This</span><br><span class="line">* can &lt;em&gt;not&lt;/em&gt; be combined with &#123;<span class="doctag">@link</span> #SOFT_INPUT_ADJUST_RESIZE&#125;; if</span><br><span class="line">* neither of these are set, then the system will try to pick one or</span><br><span class="line">* the other depending on the contents of the window.</span><br><span class="line">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SOFT_INPUT_ADJUST_PAN = <span class="number">0x20</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** Adjustment option for &#123;<span class="doctag">@link</span> #softInputMode&#125;: set to have a window</span><br><span class="line">* not adjust for a shown input method.  The window will not be resized,</span><br><span class="line">* and it will not be panned to make its focus visible.</span><br><span class="line">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SOFT_INPUT_ADJUST_NOTHING = <span class="number">0x30</span>;</span><br><span class="line">...</span><br><span class="line"><span class="comment">/**</span><br><span class="line">* Desired operating mode for any soft input area.  May be any combination</span><br><span class="line">* of:</span><br><span class="line">*</span><br><span class="line">* &lt;ul&gt;</span><br><span class="line">* &lt;li&gt; One of the visibility states</span><br><span class="line">* &#123;<span class="doctag">@link</span> #SOFT_INPUT_STATE_UNSPECIFIED&#125;, &#123;<span class="doctag">@link</span> #SOFT_INPUT_STATE_UNCHANGED&#125;,</span><br><span class="line">* &#123;<span class="doctag">@link</span> #SOFT_INPUT_STATE_HIDDEN&#125;, &#123;<span class="doctag">@link</span> #SOFT_INPUT_STATE_ALWAYS_VISIBLE&#125;, or</span><br><span class="line">* &#123;<span class="doctag">@link</span> #SOFT_INPUT_STATE_VISIBLE&#125;.</span><br><span class="line">* &lt;li&gt; One of the adjustment options</span><br><span class="line">* &#123;<span class="doctag">@link</span> #SOFT_INPUT_ADJUST_UNSPECIFIED&#125;,</span><br><span class="line">* &#123;<span class="doctag">@link</span> #SOFT_INPUT_ADJUST_RESIZE&#125;, or</span><br><span class="line">* &#123;<span class="doctag">@link</span> #SOFT_INPUT_ADJUST_PAN&#125;.</span><br><span class="line">* &lt;/ul&gt;</span><br><span class="line">*</span><br><span class="line">*</span><br><span class="line">* &lt;p&gt;This flag can be controlled in your theme through the</span><br><span class="line">* &#123;<span class="doctag">@link</span> android.R.attr#windowSoftInputMode&#125; attribute.&lt;/p&gt;</span><br><span class="line">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">int</span> softInputMode;</span><br></pre></td></tr></table></figure>
<blockquote>
<ol>
<li>SOFT_INPUT_STATE_UNSPECIFIED：没有指定软键盘输入区域的显示状态。</li>
<li>SOFT_INPUT_STATE_UNCHANGED：不要改变软键盘输入区域的显示状态。</li>
<li>SOFT_INPUT_STATE_HIDDEN：在合适的时候隐藏软键盘输入区域，例如，当用户导航到当前窗口时。</li>
<li>SOFT_INPUT_STATE_ALWAYS_HIDDEN：当窗口获得焦点时，总是隐藏软键盘输入区域。</li>
<li>SOFT_INPUT_STATE_VISIBLE：在合适的时候显示软键盘输入区域，例如，当用户导航到当前窗口时。</li>
<li>SOFT_INPUT_STATE_ALWAYS_VISIBLE：当窗口获得焦点时，总是显示软键盘输入区域。</li>
</ol>
</blockquote>
<hr>
<ul>
<li>[ ]  等待详细介绍</li>
</ul>
<hr>
<h3 id="Step5-Window-setWindowManager"><a href="#Step5-Window-setWindowManager" class="headerlink" title="Step5: Window.setWindowManager"></a>Step5: Window.setWindowManager</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Window</span> </span>&#123;</span><br><span class="line">	...</span><br><span class="line">	<span class="keyword">private</span> WindowManager mWindowManager;</span><br><span class="line">	<span class="keyword">private</span> IBinder mAppToken;</span><br><span class="line">	<span class="keyword">private</span> String mAppName;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">boolean</span> mHardwareAccelerated;</span><br><span class="line">	...</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setWindowManager</span><span class="params">(WindowManager wm, IBinder appToken, </span><br><span class="line">		String appName,<span class="keyword">boolean</span> hardwareAccelerated)</span> </span>&#123;</span><br><span class="line">		mAppToken = appToken;</span><br><span class="line">		mAppName = appName;</span><br><span class="line">		mHardwareAccelerated = hardwareAccelerated</span><br><span class="line">		 || SystemProperties.getBoolean(PROPERTY_HARDWARE_UI, <span class="keyword">false</span>);</span><br><span class="line">		<span class="keyword">if</span> (wm == <span class="keyword">null</span>) &#123;</span><br><span class="line">			wm = (WindowManager)mContext.getSystemService(Context.WINDOW_SERVICE);</span><br><span class="line">		&#125;</span><br><span class="line">		mWindowManager = ((WindowManagerImpl)wm).createLocalWindowManager(<span class="keyword">this</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>这个函数定义在文件frameworks/base/core/java/android/view/Window.java中。</p>
</blockquote>
<p>从Activity的attach方法setWindowManager,传进来一个默认的WindowManager(WindowManagerImpl，来自SystemService<br>)，调用这个WindowManager的createLocalWindowManager方法生成新的WindowManager对象保存到Window的成员mWindowManager。</p>
<p>并且在Activity中也使用成员mWindowManager保存这个Window生成的WindowManger（见Step1）。</p>
<blockquote>
<p>参数appToken用来描述当前正在处理的窗口是与哪一个Activity组件关联的，它是一个Binder代理对象，引用了在ActivityManagerService这一侧所创建的一个类型为ActivityRecord的Binder本地对象。<br>参数appName用来描述当前正在处理的窗口所关联的Activity组件的名称，这个名称会被保存在Window类的成员变量mAppName中。</p>
</blockquote>
<h3 id="Step6-WindowManagerImpl-createLocalWindowManager"><a href="#Step6-WindowManagerImpl-createLocalWindowManager" class="headerlink" title="Step6: WindowManagerImpl.createLocalWindowManager"></a>Step6: WindowManagerImpl.createLocalWindowManager</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">WindowManagerImpl</span> <span class="keyword">implements</span> <span class="title">WindowManager</span> </span>&#123;</span><br><span class="line">	...</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> WindowManagerGlobal mGlobal = WindowManagerGlobal.getInstance();</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> Display mDisplay;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> Window mParentWindow;</span><br><span class="line">	...</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="title">WindowManagerImpl</span><span class="params">(Display display, Window parentWindow)</span> </span>&#123;</span><br><span class="line">		mDisplay = display;</span><br><span class="line">		mParentWindow = parentWindow;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> WindowManagerImpl <span class="title">createLocalWindowManager</span><span class="params">(Window parentWindow)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> WindowManagerImpl(mDisplay, parentWindow);</span><br><span class="line">	&#125;</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>这个函数定义在文件frameworks/base/core/java/android/view/WindowManagerImpl.java中。</p>
</blockquote>
<p>WindowManagerGlobal是提供与上下文无关的系统窗口管理，只用于内部实现全局函数。</p>
<p>WindowManagerGlobal是一个单例，并且是窗口管理的真正现实类，不过在一般情况下，我们不直接使用使用它，而是通过已经绑定了上下文的WindowManager（WindowManagerImpl）来管理窗口。</p>
<p>所以，理所当然，WindowManager的实现类WindowManagerImpl里面需要有WindowManagerGlobal的实例，来真正处理窗口管理。</p>
<p>Display是用来描述全局的屏幕属性的，提供逻辑显示区域大小、密度的相关信息。</p>
<p>成员mParentWindow就是前面PhoneWindow实例，在创建WindowManager的时候传入的（见Step5）。</p>
<h2 id="2-类关系"><a href="#2-类关系" class="headerlink" title="2.类关系"></a>2.类关系</h2><p><img src="/images/window/Window2.png" width="748" height="603" alt="Window"></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/">Android</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/Android/">Android</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>











  
    <article id="post-Context" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/posts/Context/" class="article-date">
  	<time datetime="2016-10-28T02:30:17.000Z" itemprop="datePublished">2016-10-28</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/posts/Context/">Context的创建过程</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="1-闲言碎语"><a href="#1-闲言碎语" class="headerlink" title="1.闲言碎语"></a>1.闲言碎语</h2><p>一直想要系统的阅读Android源码，但是总是没能坚持，或许是打开方式不对。仔细想来，没必要一定从每个类的每个字段每个方法开始，没必要一定从底层开始，没必要一定从开机开始，没必要一定从启动开始。从一个点开始未必就不失为一个好的方式，用点连成线，用线连成面…。小范围跨度，低成本掌握，避免拖久必变，避免高坡度放弃，终能起到燎原之势！</p>
<p>牢骚一把。</p>
<p>进入主题，跟着<a href="http://blog.csdn.net/luoshengyang/" target="_blank" rel="external">老罗</a>练内功☞Context的创建过程。</p>
<p>ps:基于源码6.0</p>
<p>ps:原尊在<a href="http://blog.csdn.net/luoshengyang/article/details/8201936" target="_blank" rel="external">这里</a>，写的很详细。</p>
<h2 id="2-创建过程"><a href="#2-创建过程" class="headerlink" title="2.创建过程"></a>2.创建过程</h2><p><img src="/images/context/Context.png" width="1044" height="629" alt="Context"></p>
<h3 id="Step1-ActivityThread-performLaunchActivity"><a href="#Step1-ActivityThread-performLaunchActivity" class="headerlink" title="Step1: ActivityThread.performLaunchActivity"></a>Step1: ActivityThread.performLaunchActivity</h3><p>Activity组件的启动过程中，ActivityThread类的performLaunchActivity()方法会创建一个Activity实例，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> Activity <span class="title">performLaunchActivity</span><span class="params">(ActivityClientRecord r, Intent customIntent)</span> </span>&#123;</span><br><span class="line">	...</span><br><span class="line">   ActivityInfo aInfo = r.activityInfo;</span><br><span class="line">   ...</span><br><span class="line">   ComponentName component = r.intent.getComponent();</span><br><span class="line">   ...</span><br><span class="line">   Activity activity = <span class="keyword">null</span>;</span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line">       java.lang.ClassLoader cl = r.packageInfo.getClassLoader();</span><br><span class="line">       activity = mInstrumentation.newActivity(</span><br><span class="line">               cl, component.getClassName(), r.intent);</span><br><span class="line">       ...</span><br><span class="line">   &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">       ...</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line">       Application app = r.packageInfo.makeApplication(<span class="keyword">false</span>, mInstrumentation);</span><br><span class="line">       ...</span><br><span class="line">       <span class="keyword">if</span> (activity != <span class="keyword">null</span>) &#123;</span><br><span class="line">           Context appContext = createBaseContextForActivity(r, activity);</span><br><span class="line">           CharSequence title = r.activityInfo.loadLabel(appContext.getPackageManager());</span><br><span class="line">           Configuration config = <span class="keyword">new</span> Configuration(mCompatConfiguration);</span><br><span class="line">           ...</span><br><span class="line">           activity.attach(appContext, <span class="keyword">this</span>, getInstrumentation(), r.token,</span><br><span class="line">                   r.ident, app, r.intent, r.activityInfo, title, r.parent,</span><br><span class="line">                   r.embeddedID, r.lastNonConfigurationInstances, config,</span><br><span class="line">                   r.referrer, r.voiceInteractor);</span><br><span class="line">           ...</span><br><span class="line">           <span class="keyword">if</span> (r.isPersistable()) &#123;</span><br><span class="line">               mInstrumentation.callActivityOnCreate(activity, r.state, r.persistentState);</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               mInstrumentation.callActivityOnCreate(activity, r.state);</span><br><span class="line">           &#125;</span><br><span class="line">           ...</span><br><span class="line">       &#125;</span><br><span class="line">       ...</span><br><span class="line">   &#125; <span class="keyword">catch</span> (SuperNotCalledException e) &#123;</span><br><span class="line">       ...</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">       ...</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> activity;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>这个函数定义在文件frameworks/base/core/Java/android/app/ActivityThread.java中。</p>
</blockquote>
<p><em>这个方法中：</em></p>
<ul>
<li>通过mInstrumentation创建一个Activity实例。但是这个实例并没有初始化。初始化工作在activity.attach方法里进行。</li>
<li>通过方法createBaseContextForActivity()创建一个Context实例。这个方法中使用ContextImpl.createActivityContext方法生成ContextImpl实例，并将这个实例的outerContext设置为activity，将activity和这个ContextImpl实例关联，ContextImpl类里面的很多工作是通过这个outerContext完成，这样子也就是通过这个activity来完成。</li>
<li>通过activity.attach对activity进行初始化，将前面所创建的ContextImpl对象appContext以及Application对象app和Configuration对象config保存在它的内部。因为已经设置了Context，所以activity就可以访问它运行的上下文信息。activity–&gt;appContext–&gt;activity。</li>
<li>通过mInstrumentation的callActivityOnCreate方法会启动activity（调用OnCreate）。</li>
</ul>
<h3 id="Step2-Instrumentation-newActivity"><a href="#Step2-Instrumentation-newActivity" class="headerlink" title="Step2: Instrumentation.newActivity"></a>Step2: Instrumentation.newActivity</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Activity <span class="title">newActivity</span><span class="params">(ClassLoader cl, String className,Intent intent)</span></span><br><span class="line">		<span class="keyword">throws</span> InstantiationException,IllegalAccessException,</span><br><span class="line">		ClassNotFoundException </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> (Activity)cl.loadClass(className).newInstance();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>这个函数定义在文件frameworks/base/core/java/android/app/Instrumentation.java中。</p>
</blockquote>
<p>在newActivity方法中，使用ClassLoader加载对应className的类，并通过newInstance实例化对象，得到的className的类（为Activity子类）的实例。</p>
<h3 id="Step3-new-Activity"><a href="#Step3-new-Activity" class="headerlink" title="Step3: new Activity"></a>Step3: new Activity</h3><p>Activity子类实例化的时候，会调用系统提供的默认构造方法，同事调用父类的构造函数。但是，并没有执行实质的初始化工作，这个初始化工作要到attach中完成。</p>
<h3 id="Step4-ActivityThread-createBaseContextForActivity"><a href="#Step4-ActivityThread-createBaseContextForActivity" class="headerlink" title="Step4: ActivityThread.createBaseContextForActivity"></a>Step4: ActivityThread.createBaseContextForActivity</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Context <span class="title">createBaseContextForActivity</span><span class="params">(ActivityClientRecord r, <span class="keyword">final</span> Activity activity)</span> </span>&#123;</span><br><span class="line">	...</span><br><span class="line">	ContextImpl appContext = ContextImpl.createActivityContext(<span class="keyword">this</span>, r.packageInfo, displayId, r.overrideConfig);</span><br><span class="line">	appContext.setOuterContext(activity);</span><br><span class="line">	Context baseContext = appContext;</span><br><span class="line">	...</span><br><span class="line">	baseContext = appContext.createDisplayContext(display);</span><br><span class="line">	...</span><br><span class="line">	<span class="keyword">return</span> baseContext;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>这个函数定义在文件frameworks/base/core/Java/android/app/ActivityThread.java中。</p>
</blockquote>
<p>activity虽然创建，但是还需要设置Context。通过ActivityThread的createBaseContextForActivity创建一个ContextImpl的实例appContext。通过setOuterContext方法将activity设置为这个实例的OuterContext，同时将这个实例设置给Activity（见Step8）。这样，将Context和Activity进行关联，Activity有个成员mBase（来自ContextWrapper）指向appContext，ContextImpl有个成员mOuterContext指向activity。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">activity.mBase --&gt; appContext</span><br><span class="line">appContext.mOuterContext --&gt; activity</span><br></pre></td></tr></table></figure>
<h3 id="Step5-createActivityContext"><a href="#Step5-createActivityContext" class="headerlink" title="Step5: createActivityContext"></a>Step5: createActivityContext</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> ContextImpl <span class="title">createActivityContext</span><span class="params">(ActivityThread mainThread,</span><br><span class="line">		LoadedApk packageInfo, <span class="keyword">int</span> displayId, Configuration overrideConfiguration)</span> </span>&#123;</span><br><span class="line">		</span><br><span class="line">	<span class="keyword">if</span> (packageInfo == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"packageInfo"</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">new</span> ContextImpl(<span class="keyword">null</span>, mainThread, packageInfo, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">false</span>,</span><br><span class="line">		<span class="keyword">null</span>, overrideConfiguration, displayId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="title">ContextImpl</span><span class="params">(ContextImpl container, ActivityThread mainThread,</span><br><span class="line">	LoadedApk packageInfo, IBinder activityToken, UserHandle user, <span class="keyword">boolean</span></span><br><span class="line">	restricted, Display display, Configuration overrideConfiguration, </span><br><span class="line">	<span class="keyword">int</span> createDisplayWithId)</span> </span>&#123;</span><br><span class="line">	mOuterContext = <span class="keyword">this</span>;</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>这个函数定义在文件frameworks/base/core/Java/android/app/ContextImpl.java中。</p>
</blockquote>
<p>ContextImpl在初始化的时候，mOuterContext指向的是自己，只有通过setOuterContext之后才指向activity(见下面Step6)。</p>
<h3 id="Step6-setOuterContext"><a href="#Step6-setOuterContext" class="headerlink" title="Step6: setOuterContext"></a>Step6: setOuterContext</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ContextImpl</span> <span class="keyword">extends</span> <span class="title">Context</span> </span>&#123;</span><br><span class="line">	...</span><br><span class="line">	<span class="keyword">private</span> Context mOuterContext;</span><br><span class="line">	...</span><br><span class="line">	<span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">setOuterContext</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">		mOuterContext = context;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>这个函数定义在文件frameworks/base/core/Java/android/app/ContextImpl.java中。</p>
</blockquote>
<p>如此，mOuterContext指向Activity。</p>
<h3 id="Step7-Activity-attach"><a href="#Step7-Activity-attach" class="headerlink" title="Step7: Activity attach"></a>Step7: Activity attach</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">attach</span><span class="params">(Context context, ActivityThread aThread,</span><br><span class="line">	Instrumentation instr, IBinder token, <span class="keyword">int</span> ident,</span><br><span class="line">	Application application, Intent intent, ActivityInfo info,</span><br><span class="line">	CharSequence title, Activity parent, String id,</span><br><span class="line">	NonConfigurationInstances lastNonConfigurationInstances,</span><br><span class="line">	Configuration config, String referrer, IVoiceInteractor voiceInteractor)</span></span>&#123;</span><br><span class="line">	attachBaseContext(context);</span><br><span class="line">	mFragments.attachHost(<span class="keyword">null</span> <span class="comment">/*parent*/</span>);</span><br><span class="line"></span><br><span class="line">	mWindow = <span class="keyword">new</span> PhoneWindow(<span class="keyword">this</span>);</span><br><span class="line">	mWindow.setCallback(<span class="keyword">this</span>);</span><br><span class="line">	mWindow.setOnWindowDismissedCallback(<span class="keyword">this</span>);</span><br><span class="line">	mWindow.getLayoutInflater().setPrivateFactory(<span class="keyword">this</span>);</span><br><span class="line">	<span class="keyword">if</span> (info.softInputMode != WindowManager.LayoutParams.SOFT_INPUT_STATE_UNSPECIFIED) &#123;</span><br><span class="line">		mWindow.setSoftInputMode(info.softInputMode);</span><br><span class="line">	&#125;</span><br><span class="line">	...</span><br><span class="line">	mApplication = application;</span><br><span class="line">	...</span><br><span class="line">	mWindow.setWindowManager(</span><br><span class="line">		(WindowManager)context.getSystemService(Context.WINDOW_SERVICE),</span><br><span class="line">		mToken, mComponent.flattenToString(),</span><br><span class="line">		(info.flags &amp; ActivityInfo.FLAG_HARDWARE_ACCELERATED) != <span class="number">0</span>);</span><br><span class="line"> 	...</span><br><span class="line"> 	mWindowManager = mWindow.getWindowManager();</span><br><span class="line"> 	mCurrentConfig = config;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>这个函数定义在文件frameworks/base/core/java/android/app/Activity.java中。</p>
</blockquote>
<p><em>这个方法：</em></p>
<ul>
<li>用attachBaseContext方法保存了context。</li>
<li>创建了一个PhoneWindow实例赋值给mWindow，并setCallback，setOnWindowDismissedCallback。</li>
<li>用mApplication保存application。</li>
<li>设置mWindow的WindowManager。</li>
<li>用mWindowManager保存这个WindowManager。</li>
<li>用mCurrentConfig保存config</li>
</ul>
<p><em>其中：</em></p>
<blockquote>
<p>这个PhoneWindow是用来描述当前正在启动的应用程序窗口的。这个应用程序窗口在运行的过程中，会接收到一些事件，例如，键盘、触摸屏事件等，这些事件需要转发给与它所关联的Activity组件处理，这个转发操作是通过一个Window.Callback接口来实现的。由于Activity类实现了Window.Callback接口，因此，函数就可以将当前正在启动的Activity组件所实现的一个Window.Callback接口设置到前面创建的一个PhoneWindow里面去，这是通过调用Window类的成员函数setCallback来实现的。</p>
</blockquote>
<p>ps:Window应属另一个点了，静候佳音…</p>
<h3 id="Step8-ContextThemeWrapper-attachBaseConext"><a href="#Step8-ContextThemeWrapper-attachBaseConext" class="headerlink" title="Step8:  ContextThemeWrapper.attachBaseConext"></a>Step8:  ContextThemeWrapper.attachBaseConext</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">attachBaseContext</span><span class="params">(Context newBase)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">super</span>.attachBaseContext(newBase);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>这个函数定义在文件frameworks/base/core/java/android/view/ContextThemeWrapper.java中。</p>
</blockquote>
<h3 id="Step-9-ContextWrapper-attachBaseConext"><a href="#Step-9-ContextWrapper-attachBaseConext" class="headerlink" title="Step 9: ContextWrapper.attachBaseConext"></a>Step 9: ContextWrapper.attachBaseConext</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ContextWrapper</span> <span class="keyword">extends</span> <span class="title">Context</span> </span>&#123;</span><br><span class="line">	Context mBase;</span><br><span class="line">	...</span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">attachBaseContext</span><span class="params">(Context base)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (mBase != <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Base context already set"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		mBase = base;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>这个函数定义在文件frameworks/base/core/java/android/content/ContextWrapper.java 中。</p>
</blockquote>
<h3 id="Step-10-Instrumentation-callActivityOnCreate"><a href="#Step-10-Instrumentation-callActivityOnCreate" class="headerlink" title="Step 10: Instrumentation.callActivityOnCreate"></a>Step 10: Instrumentation.callActivityOnCreate</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">callActivityOnCreate</span><span class="params">(Activity activity, Bundle icicle,</span><br><span class="line">		PersistableBundle persistentState)</span> </span>&#123;</span><br><span class="line">	prePerformCreate(activity);</span><br><span class="line">	activity.performCreate(icicle, persistentState);</span><br><span class="line">	postPerformCreate(activity);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>这个函数定义在文件frameworks/base/core/java/android/app/Instrumentation.java中。</p>
</blockquote>
<h3 id="Step-11-Activity-performCreate"><a href="#Step-11-Activity-performCreate" class="headerlink" title="Step 11: Activity.performCreate"></a>Step 11: Activity.performCreate</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">performCreate</span><span class="params">(Bundle icicle, PersistableBundle persistentState)</span> </span>&#123;</span><br><span class="line">	onCreate(icicle, persistentState);</span><br><span class="line">	mActivityTransitionState.readState(icicle);</span><br><span class="line">	performCreateCommon();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>这个函数定义在文件frameworks/base/core/java/android/app/Activity.java中。</p>
</blockquote>
<h3 id="Step-12-Activity-onCreate"><a href="#Step-12-Activity-onCreate" class="headerlink" title="Step 12: Activity.onCreate"></a>Step 12: Activity.onCreate</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(@Nullable Bundle savedInstanceState,</span><br><span class="line">		@Nullable PersistableBundle persistentState)</span> </span>&#123;</span><br><span class="line">	onCreate(savedInstanceState);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>这个函数定义在文件frameworks/base/core/java/android/app/Activity.java中。</p>
</blockquote>
<h3 id="Step-13-Activity-onCreate"><a href="#Step-13-Activity-onCreate" class="headerlink" title="Step 13: Activity.onCreate"></a>Step 13: Activity.onCreate</h3><p>我们所熟悉的onCreate方法。（略）</p>
<h2 id="3-类关系"><a href="#3-类关系" class="headerlink" title="3.类关系"></a>3.类关系</h2><p>通过上面我们调用过程我们知道ContextImpl和Activity的关系，下面我们在看看它们的类关系：</p>
<p><img src="/images/context/Context_class.png" width="733" height="448" alt="Context_class"></p>
<blockquote>
<p> 这个类图在设计模式里面就可以称为装饰模式。Activity组件通过其父类ContextWrapper的成员变量mBase来引用了一个ContextImpl对象，这样，Activity组件以后就可以通过这个ContextImpl对象来执行一些具体的操作。同时，ContextImpl类又通过自己的成员变量mOuterContext来引用了与它关联的一个Activity组件，这样，ContextImpl类也可以将一些操作转发给Activity组件来处理。</p>
</blockquote>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/">Android</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/Android/">Android</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>











  
  
    <nav id="page-nav">
      <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/">Next &raquo;</a>
    </nav>
  
</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2018 青林亦
    		<script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1257786708'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s11.cnzz.com/z_stat.php%3Fid%3D1257786708%26online%3D1%26show%3Dline' type='text/javascript'%3E%3C/script%3E"));</script>
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten
      	</div>
    </div>
  </div>
</footer>
    </div>
    
  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">


<script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: true,
		animate: true,
		isHome: true,
		isPost: false,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false
	}
</script>
<script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>
<script src="/js/main.js"></script>






<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  </div>
</body>
</html>